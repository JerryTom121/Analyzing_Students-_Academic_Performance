<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<script src="data:application/x-javascript;base64,KGZ1bmN0aW9uKCkgewogIC8vIElmIHdpbmRvdy5IVE1MV2lkZ2V0cyBpcyBhbHJlYWR5IGRlZmluZWQsIHRoZW4gdXNlIGl0OyBvdGhlcndpc2UgY3JlYXRlIGEKICAvLyBuZXcgb2JqZWN0LiBUaGlzIGFsbG93cyBwcmVjZWRpbmcgY29kZSB0byBzZXQgb3B0aW9ucyB0aGF0IGFmZmVjdCB0aGUKICAvLyBpbml0aWFsaXphdGlvbiBwcm9jZXNzICh0aG91Z2ggbm9uZSBjdXJyZW50bHkgZXhpc3QpLgogIHdpbmRvdy5IVE1MV2lkZ2V0cyA9IHdpbmRvdy5IVE1MV2lkZ2V0cyB8fCB7fTsKCiAgLy8gU2VlIGlmIHdlJ3JlIHJ1bm5pbmcgaW4gYSB2aWV3ZXIgcGFuZS4gSWYgbm90LCB3ZSdyZSBpbiBhIHdlYiBicm93c2VyLgogIHZhciB2aWV3ZXJNb2RlID0gd2luZG93LkhUTUxXaWRnZXRzLnZpZXdlck1vZGUgPQogICAgICAvXGJ2aWV3ZXJfcGFuZT0xXGIvLnRlc3Qod2luZG93LmxvY2F0aW9uKTsKCiAgLy8gU2VlIGlmIHdlJ3JlIHJ1bm5pbmcgaW4gU2hpbnkgbW9kZS4gSWYgbm90LCBpdCdzIGEgc3RhdGljIGRvY3VtZW50LgogIC8vIE5vdGUgdGhhdCBzdGF0aWMgd2lkZ2V0cyBjYW4gYXBwZWFyIGluIGJvdGggU2hpbnkgYW5kIHN0YXRpYyBtb2RlcywgYnV0CiAgLy8gb2J2aW91c2x5LCBTaGlueSB3aWRnZXRzIGNhbiBvbmx5IGFwcGVhciBpbiBTaGlueSBhcHBzL2RvY3VtZW50cy4KICB2YXIgc2hpbnlNb2RlID0gd2luZG93LkhUTUxXaWRnZXRzLnNoaW55TW9kZSA9CiAgICAgIHR5cGVvZih3aW5kb3cuU2hpbnkpICE9PSAidW5kZWZpbmVkIiAmJiAhIXdpbmRvdy5TaGlueS5vdXRwdXRCaW5kaW5nczsKCiAgLy8gV2UgY2FuJ3QgY291bnQgb24galF1ZXJ5IGJlaW5nIGF2YWlsYWJsZSwgc28gd2UgaW1wbGVtZW50IG91ciBvd24KICAvLyB2ZXJzaW9uIGlmIG5lY2Vzc2FyeS4KICBmdW5jdGlvbiBxdWVyeVNlbGVjdG9yQWxsKHNjb3BlLCBzZWxlY3RvcikgewogICAgaWYgKHR5cGVvZihqUXVlcnkpICE9PSAidW5kZWZpbmVkIiAmJiBzY29wZSBpbnN0YW5jZW9mIGpRdWVyeSkgewogICAgICByZXR1cm4gc2NvcGUuZmluZChzZWxlY3Rvcik7CiAgICB9CiAgICBpZiAoc2NvcGUucXVlcnlTZWxlY3RvckFsbCkgewogICAgICByZXR1cm4gc2NvcGUucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvcik7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhc0FycmF5KHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT09IG51bGwpCiAgICAgIHJldHVybiBbXTsKICAgIGlmICgkLmlzQXJyYXkodmFsdWUpKQogICAgICByZXR1cm4gdmFsdWU7CiAgICByZXR1cm4gW3ZhbHVlXTsKICB9CgogIC8vIEltcGxlbWVudCBqUXVlcnkncyBleHRlbmQKICBmdW5jdGlvbiBleHRlbmQodGFyZ2V0IC8qLCAuLi4gKi8pIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBzb3VyY2UgPSBhcmd1bWVudHNbaV07CiAgICAgIGZvciAodmFyIHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgaWYgKHNvdXJjZS5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewogICAgICAgICAgdGFyZ2V0W3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIHRhcmdldDsKICB9CgogIC8vIElFOCBkb2Vzbid0IHN1cHBvcnQgQXJyYXkuZm9yRWFjaC4KICBmdW5jdGlvbiBmb3JFYWNoKHZhbHVlcywgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIGlmICh2YWx1ZXMuZm9yRWFjaCkgewogICAgICB2YWx1ZXMuZm9yRWFjaChjYWxsYmFjaywgdGhpc0FyZyk7CiAgICB9IGVsc2UgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgIGNhbGxiYWNrLmNhbGwodGhpc0FyZywgdmFsdWVzW2ldLCBpLCB2YWx1ZXMpOwogICAgICB9CiAgICB9CiAgfQoKICAvLyBSZXBsYWNlcyB0aGUgc3BlY2lmaWVkIG1ldGhvZCB3aXRoIHRoZSByZXR1cm4gdmFsdWUgb2YgZnVuY1NvdXJjZS4KICAvLwogIC8vIE5vdGUgdGhhdCBmdW5jU291cmNlIHNob3VsZCBub3QgQkUgdGhlIG5ldyBtZXRob2QsIGl0IHNob3VsZCBiZSBhIGZ1bmN0aW9uCiAgLy8gdGhhdCBSRVRVUk5TIHRoZSBuZXcgbWV0aG9kLiBmdW5jU291cmNlIHJlY2VpdmVzIGEgc2luZ2xlIGFyZ3VtZW50IHRoYXQgaXMKICAvLyB0aGUgb3ZlcnJpZGRlbiBtZXRob2QsIGl0IGNhbiBiZSBjYWxsZWQgZnJvbSB0aGUgbmV3IG1ldGhvZC4gVGhlIG92ZXJyaWRkZW4KICAvLyBtZXRob2QgY2FuIGJlIGNhbGxlZCBsaWtlIGEgcmVndWxhciBmdW5jdGlvbiwgaXQgaGFzIHRoZSB0YXJnZXQgcGVybWFuZW50bHkKICAvLyBib3VuZCB0byBpdCBzbyAidGhpcyIgd2lsbCB3b3JrIGNvcnJlY3RseS4KICBmdW5jdGlvbiBvdmVycmlkZU1ldGhvZCh0YXJnZXQsIG1ldGhvZE5hbWUsIGZ1bmNTb3VyY2UpIHsKICAgIHZhciBzdXBlckZ1bmMgPSB0YXJnZXRbbWV0aG9kTmFtZV0gfHwgZnVuY3Rpb24oKSB7fTsKICAgIHZhciBzdXBlckZ1bmNCb3VuZCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc3VwZXJGdW5jLmFwcGx5KHRhcmdldCwgYXJndW1lbnRzKTsKICAgIH07CiAgICB0YXJnZXRbbWV0aG9kTmFtZV0gPSBmdW5jU291cmNlKHN1cGVyRnVuY0JvdW5kKTsKICB9CgogIC8vIEFkZCBhIG1ldGhvZCB0byBkZWxlZ2F0b3IgdGhhdCwgd2hlbiBpbnZva2VkLCBjYWxscwogIC8vIGRlbGVnYXRlZS5tZXRob2ROYW1lLiBJZiB0aGVyZSBpcyBubyBzdWNoIG1ldGhvZCBvbgogIC8vIHRoZSBkZWxlZ2F0ZWUsIGJ1dCB0aGVyZSB3YXMgb25lIG9uIGRlbGVnYXRvciBiZWZvcmUKICAvLyBkZWxlZ2F0ZU1ldGhvZCB3YXMgY2FsbGVkLCB0aGVuIHRoZSBvcmlnaW5hbCB2ZXJzaW9uCiAgLy8gaXMgaW52b2tlZCBpbnN0ZWFkLgogIC8vIEZvciBleGFtcGxlOgogIC8vCiAgLy8gdmFyIGEgPSB7CiAgLy8gICBtZXRob2QxOiBmdW5jdGlvbigpIHsgY29uc29sZS5sb2coJ2ExJyk7IH0KICAvLyAgIG1ldGhvZDI6IGZ1bmN0aW9uKCkgeyBjb25zb2xlLmxvZygnYTInKTsgfQogIC8vIH07CiAgLy8gdmFyIGIgPSB7CiAgLy8gICBtZXRob2QxOiBmdW5jdGlvbigpIHsgY29uc29sZS5sb2coJ2IxJyk7IH0KICAvLyB9OwogIC8vIGRlbGVnYXRlTWV0aG9kKGEsIGIsICJtZXRob2QxIik7CiAgLy8gZGVsZWdhdGVNZXRob2QoYSwgYiwgIm1ldGhvZDIiKTsKICAvLyBhLm1ldGhvZDEoKTsKICAvLyBhLm1ldGhvZDIoKTsKICAvLwogIC8vIFRoZSBvdXRwdXQgd291bGQgYmUgImIxIiwgImEyIi4KICBmdW5jdGlvbiBkZWxlZ2F0ZU1ldGhvZChkZWxlZ2F0b3IsIGRlbGVnYXRlZSwgbWV0aG9kTmFtZSkgewogICAgdmFyIGluaGVyaXRlZCA9IGRlbGVnYXRvclttZXRob2ROYW1lXTsKICAgIGRlbGVnYXRvclttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdGFyZ2V0ID0gZGVsZWdhdGVlOwogICAgICB2YXIgbWV0aG9kID0gZGVsZWdhdGVlW21ldGhvZE5hbWVdOwoKICAgICAgLy8gVGhlIG1ldGhvZCBkb2Vzbid0IGV4aXN0IG9uIHRoZSBkZWxlZ2F0ZWUuIEluc3RlYWQsCiAgICAgIC8vIGNhbGwgdGhlIG1ldGhvZCBvbiB0aGUgZGVsZWdhdG9yLCBpZiBpdCBleGlzdHMuCiAgICAgIGlmICghbWV0aG9kKSB7CiAgICAgICAgdGFyZ2V0ID0gZGVsZWdhdG9yOwogICAgICAgIG1ldGhvZCA9IGluaGVyaXRlZDsKICAgICAgfQoKICAgICAgaWYgKG1ldGhvZCkgewogICAgICAgIHJldHVybiBtZXRob2QuYXBwbHkodGFyZ2V0LCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9OwogIH0KCiAgLy8gSW1wbGVtZW50IGEgdmFndWUgZmFjc2ltaWxpZSBvZiBqUXVlcnkncyBkYXRhIG1ldGhvZAogIGZ1bmN0aW9uIGVsZW1lbnREYXRhKGVsLCBuYW1lLCB2YWx1ZSkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMikgewogICAgICByZXR1cm4gZWxbImh0bWx3aWRnZXRfZGF0YV8iICsgbmFtZV07CiAgICB9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMykgewogICAgICBlbFsiaHRtbHdpZGdldF9kYXRhXyIgKyBuYW1lXSA9IHZhbHVlOwogICAgICByZXR1cm4gZWw7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIldyb25nIG51bWJlciBvZiBhcmd1bWVudHMgZm9yIGVsZW1lbnREYXRhOiAiICsKICAgICAgICBhcmd1bWVudHMubGVuZ3RoKTsKICAgIH0KICB9CgogIC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzQ0NjE3MC9lc2NhcGUtc3RyaW5nLWZvci11c2UtaW4tamF2YXNjcmlwdC1yZWdleAogIGZ1bmN0aW9uIGVzY2FwZVJlZ0V4cChzdHIpIHsKICAgIHJldHVybiBzdHIucmVwbGFjZSgvW1wtXFtcXVwvXHtcfVwoXClcKlwrXD9cLlxcXF5cJFx8XS9nLCAiXFwkJiIpOwogIH0KCiAgZnVuY3Rpb24gaGFzQ2xhc3MoZWwsIGNsYXNzTmFtZSkgewogICAgdmFyIHJlID0gbmV3IFJlZ0V4cCgiXFxiIiArIGVzY2FwZVJlZ0V4cChjbGFzc05hbWUpICsgIlxcYiIpOwogICAgcmV0dXJuIHJlLnRlc3QoZWwuY2xhc3NOYW1lKTsKICB9CgogIC8vIGVsZW1lbnRzIC0gYXJyYXkgKG9yIGFycmF5LWxpa2Ugb2JqZWN0KSBvZiBIVE1MIGVsZW1lbnRzCiAgLy8gY2xhc3NOYW1lIC0gY2xhc3MgbmFtZSB0byB0ZXN0IGZvcgogIC8vIGluY2x1ZGUgLSBpZiB0cnVlLCBvbmx5IHJldHVybiBlbGVtZW50cyB3aXRoIGdpdmVuIGNsYXNzTmFtZTsKICAvLyAgIGlmIGZhbHNlLCBvbmx5IHJldHVybiBlbGVtZW50cyAqd2l0aG91dCogZ2l2ZW4gY2xhc3NOYW1lCiAgZnVuY3Rpb24gZmlsdGVyQnlDbGFzcyhlbGVtZW50cywgY2xhc3NOYW1lLCBpbmNsdWRlKSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICBpZiAoaGFzQ2xhc3MoZWxlbWVudHNbaV0sIGNsYXNzTmFtZSkgPT0gaW5jbHVkZSkKICAgICAgICByZXN1bHRzLnB1c2goZWxlbWVudHNbaV0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdHM7CiAgfQoKICBmdW5jdGlvbiBvbihvYmosIGV2ZW50TmFtZSwgZnVuYykgewogICAgaWYgKG9iai5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgIG9iai5hZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgZnVuYywgZmFsc2UpOwogICAgfSBlbHNlIGlmIChvYmouYXR0YWNoRXZlbnQpIHsKICAgICAgb2JqLmF0dGFjaEV2ZW50KGV2ZW50TmFtZSwgZnVuYyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBvZmYob2JqLCBldmVudE5hbWUsIGZ1bmMpIHsKICAgIGlmIChvYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcikKICAgICAgb2JqLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBmdW5jLCBmYWxzZSk7CiAgICBlbHNlIGlmIChvYmouZGV0YWNoRXZlbnQpIHsKICAgICAgb2JqLmRldGFjaEV2ZW50KGV2ZW50TmFtZSwgZnVuYyk7CiAgICB9CiAgfQoKICAvLyBUcmFuc2xhdGUgYXJyYXkgb2YgdmFsdWVzIHRvIHRvcC9yaWdodC9ib3R0b20vbGVmdCwgYXMgdXN1YWwgd2l0aAogIC8vIHRoZSAicGFkZGluZyIgQ1NTIHByb3BlcnR5CiAgLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQ1NTL3BhZGRpbmcKICBmdW5jdGlvbiB1bnBhY2tQYWRkaW5nKHZhbHVlKSB7CiAgICBpZiAodHlwZW9mKHZhbHVlKSA9PT0gIm51bWJlciIpCiAgICAgIHZhbHVlID0gW3ZhbHVlXTsKICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDEpIHsKICAgICAgcmV0dXJuIHt0b3A6IHZhbHVlWzBdLCByaWdodDogdmFsdWVbMF0sIGJvdHRvbTogdmFsdWVbMF0sIGxlZnQ6IHZhbHVlWzBdfTsKICAgIH0KICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDIpIHsKICAgICAgcmV0dXJuIHt0b3A6IHZhbHVlWzBdLCByaWdodDogdmFsdWVbMV0sIGJvdHRvbTogdmFsdWVbMF0sIGxlZnQ6IHZhbHVlWzFdfTsKICAgIH0KICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDMpIHsKICAgICAgcmV0dXJuIHt0b3A6IHZhbHVlWzBdLCByaWdodDogdmFsdWVbMV0sIGJvdHRvbTogdmFsdWVbMl0sIGxlZnQ6IHZhbHVlWzFdfTsKICAgIH0KICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDQpIHsKICAgICAgcmV0dXJuIHt0b3A6IHZhbHVlWzBdLCByaWdodDogdmFsdWVbMV0sIGJvdHRvbTogdmFsdWVbMl0sIGxlZnQ6IHZhbHVlWzNdfTsKICAgIH0KICB9CgogIC8vIENvbnZlcnQgYW4gdW5wYWNrZWQgcGFkZGluZyBvYmplY3QgdG8gYSBDU1MgdmFsdWUKICBmdW5jdGlvbiBwYWRkaW5nVG9Dc3MocGFkZGluZ09iaikgewogICAgcmV0dXJuIHBhZGRpbmdPYmoudG9wICsgInB4ICIgKyBwYWRkaW5nT2JqLnJpZ2h0ICsgInB4ICIgKyBwYWRkaW5nT2JqLmJvdHRvbSArICJweCAiICsgcGFkZGluZ09iai5sZWZ0ICsgInB4IjsKICB9CgogIC8vIE1ha2VzIGEgbnVtYmVyIHN1aXRhYmxlIGZvciBDU1MKICBmdW5jdGlvbiBweCh4KSB7CiAgICBpZiAodHlwZW9mKHgpID09PSAibnVtYmVyIikKICAgICAgcmV0dXJuIHggKyAicHgiOwogICAgZWxzZQogICAgICByZXR1cm4geDsKICB9CgogIC8vIFJldHJpZXZlcyBydW50aW1lIHdpZGdldCBzaXppbmcgaW5mb3JtYXRpb24gZm9yIGFuIGVsZW1lbnQuCiAgLy8gVGhlIHJldHVybiB2YWx1ZSBpcyBlaXRoZXIgbnVsbCwgb3IgYW4gb2JqZWN0IHdpdGggZmlsbCwgcGFkZGluZywKICAvLyBkZWZhdWx0V2lkdGgsIGRlZmF1bHRIZWlnaHQgZmllbGRzLgogIGZ1bmN0aW9uIHNpemluZ1BvbGljeShlbCkgewogICAgdmFyIHNpemluZ0VsID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcigic2NyaXB0W2RhdGEtZm9yPSciICsgZWwuaWQgKyAiJ11bdHlwZT0nYXBwbGljYXRpb24vaHRtbHdpZGdldC1zaXppbmcnXSIpOwogICAgaWYgKCFzaXppbmdFbCkKICAgICAgcmV0dXJuIG51bGw7CiAgICB2YXIgc3AgPSBKU09OLnBhcnNlKHNpemluZ0VsLnRleHRDb250ZW50IHx8IHNpemluZ0VsLnRleHQgfHwgInt9Iik7CiAgICBpZiAodmlld2VyTW9kZSkgewogICAgICByZXR1cm4gc3Audmlld2VyOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHNwLmJyb3dzZXI7CiAgICB9CiAgfQoKICAvLyBAcGFyYW0gdGFza3MgQXJyYXkgb2Ygc3RyaW5ncyAob3IgZmFsc3kgdmFsdWUsIGluIHdoaWNoIGNhc2Ugbm8tb3ApLgogIC8vICAgRWFjaCBlbGVtZW50IG11c3QgYmUgYSB2YWxpZCBKYXZhU2NyaXB0IGV4cHJlc3Npb24gdGhhdCB5aWVsZHMgYQogIC8vICAgZnVuY3Rpb24uIE9yLCBjYW4gYmUgYW4gYXJyYXkgb2Ygb2JqZWN0cyB3aXRoICJjb2RlIiBhbmQgImRhdGEiCiAgLy8gICBwcm9wZXJ0aWVzOyBpbiB0aGlzIGNhc2UsIHRoZSAiY29kZSIgcHJvcGVydHkgc2hvdWxkIGJlIGEgc3RyaW5nCiAgLy8gICBvZiBKUyB0aGF0J3MgYW4gZXhwciB0aGF0IHlpZWxkcyBhIGZ1bmN0aW9uLCBhbmQgImRhdGEiIHNob3VsZCBiZQogIC8vICAgYW4gb2JqZWN0IHRoYXQgd2lsbCBiZSBhZGRlZCBhcyBhbiBhZGRpdGlvbmFsIGFyZ3VtZW50IHdoZW4gdGhhdAogIC8vICAgZnVuY3Rpb24gaXMgY2FsbGVkLgogIC8vIEBwYXJhbSB0YXJnZXQgVGhlIG9iamVjdCB0aGF0IHdpbGwgYmUgInRoaXMiIGZvciBlYWNoIGZ1bmN0aW9uCiAgLy8gICBleGVjdXRpb24uCiAgLy8gQHBhcmFtIGFyZ3MgQXJyYXkgb2YgYXJndW1lbnRzIHRvIGJlIHBhc3NlZCB0byB0aGUgZnVuY3Rpb25zLiAoVGhlCiAgLy8gICBzYW1lIGFyZ3VtZW50cyB3aWxsIGJlIHBhc3NlZCB0byBhbGwgZnVuY3Rpb25zLikKICBmdW5jdGlvbiBldmFsQW5kUnVuKHRhc2tzLCB0YXJnZXQsIGFyZ3MpIHsKICAgIGlmICh0YXNrcykgewogICAgICBmb3JFYWNoKHRhc2tzLCBmdW5jdGlvbih0YXNrKSB7CiAgICAgICAgdmFyIHRoZXNlQXJncyA9IGFyZ3M7CiAgICAgICAgaWYgKHR5cGVvZih0YXNrKSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgIHRoZXNlQXJncyA9IHRoZXNlQXJncy5jb25jYXQoW3Rhc2suZGF0YV0pOwogICAgICAgICAgdGFzayA9IHRhc2suY29kZTsKICAgICAgICB9CiAgICAgICAgdmFyIHRhc2tGdW5jID0gZXZhbCgiKCIgKyB0YXNrICsgIikiKTsKICAgICAgICBpZiAodHlwZW9mKHRhc2tGdW5jKSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXNrIG11c3QgYmUgYSBmdW5jdGlvbiEgU291cmNlOlxuIiArIHRhc2spOwogICAgICAgIH0KICAgICAgICB0YXNrRnVuYy5hcHBseSh0YXJnZXQsIHRoZXNlQXJncyk7CiAgICAgIH0pOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaW5pdFNpemluZyhlbCkgewogICAgdmFyIHNpemluZyA9IHNpemluZ1BvbGljeShlbCk7CiAgICBpZiAoIXNpemluZykKICAgICAgcmV0dXJuOwoKICAgIHZhciBjZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiaHRtbHdpZGdldF9jb250YWluZXIiKTsKICAgIGlmICghY2VsKQogICAgICByZXR1cm47CgogICAgaWYgKHR5cGVvZihzaXppbmcucGFkZGluZykgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUubWFyZ2luID0gIjAiOwogICAgICBkb2N1bWVudC5ib2R5LnN0eWxlLnBhZGRpbmcgPSBwYWRkaW5nVG9Dc3ModW5wYWNrUGFkZGluZyhzaXppbmcucGFkZGluZykpOwogICAgfQoKICAgIGlmIChzaXppbmcuZmlsbCkgewogICAgICBkb2N1bWVudC5ib2R5LnN0eWxlLm92ZXJmbG93ID0gImhpZGRlbiI7CiAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUud2lkdGggPSAiMTAwJSI7CiAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUuaGVpZ2h0ID0gIjEwMCUiOwogICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGUud2lkdGggPSAiMTAwJSI7CiAgICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZS5oZWlnaHQgPSAiMTAwJSI7CiAgICAgIGlmIChjZWwpIHsKICAgICAgICBjZWwuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOwogICAgICAgIHZhciBwYWQgPSB1bnBhY2tQYWRkaW5nKHNpemluZy5wYWRkaW5nKTsKICAgICAgICBjZWwuc3R5bGUudG9wID0gcGFkLnRvcCArICJweCI7CiAgICAgICAgY2VsLnN0eWxlLnJpZ2h0ID0gcGFkLnJpZ2h0ICsgInB4IjsKICAgICAgICBjZWwuc3R5bGUuYm90dG9tID0gcGFkLmJvdHRvbSArICJweCI7CiAgICAgICAgY2VsLnN0eWxlLmxlZnQgPSBwYWQubGVmdCArICJweCI7CiAgICAgICAgZWwuc3R5bGUud2lkdGggPSAiMTAwJSI7CiAgICAgICAgZWwuc3R5bGUuaGVpZ2h0ID0gIjEwMCUiOwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIGdldFdpZHRoOiBmdW5jdGlvbigpIHsgcmV0dXJuIGNlbC5vZmZzZXRXaWR0aDsgfSwKICAgICAgICBnZXRIZWlnaHQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gY2VsLm9mZnNldEhlaWdodDsgfQogICAgICB9OwoKICAgIH0gZWxzZSB7CiAgICAgIGVsLnN0eWxlLndpZHRoID0gcHgoc2l6aW5nLndpZHRoKTsKICAgICAgZWwuc3R5bGUuaGVpZ2h0ID0gcHgoc2l6aW5nLmhlaWdodCk7CgogICAgICByZXR1cm4gewogICAgICAgIGdldFdpZHRoOiBmdW5jdGlvbigpIHsgcmV0dXJuIGVsLm9mZnNldFdpZHRoOyB9LAogICAgICAgIGdldEhlaWdodDogZnVuY3Rpb24oKSB7IHJldHVybiBlbC5vZmZzZXRIZWlnaHQ7IH0KICAgICAgfTsKICAgIH0KICB9CgogIC8vIERlZmF1bHQgaW1wbGVtZW50YXRpb25zIGZvciBtZXRob2RzCiAgdmFyIGRlZmF1bHRzID0gewogICAgZmluZDogZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgcmV0dXJuIHF1ZXJ5U2VsZWN0b3JBbGwoc2NvcGUsICIuIiArIHRoaXMubmFtZSk7CiAgICB9LAogICAgcmVuZGVyRXJyb3I6IGZ1bmN0aW9uKGVsLCBlcnIpIHsKICAgICAgdmFyICRlbCA9ICQoZWwpOwoKICAgICAgdGhpcy5jbGVhckVycm9yKGVsKTsKCiAgICAgIC8vIEFkZCBhbGwgdGhlc2UgZXJyb3IgY2xhc3NlcywgYXMgU2hpbnkgZG9lcwogICAgICB2YXIgZXJyQ2xhc3MgPSAic2hpbnktb3V0cHV0LWVycm9yIjsKICAgICAgaWYgKGVyci50eXBlICE9PSBudWxsKSB7CiAgICAgICAgLy8gdXNlIHRoZSBjbGFzc2VzIG9mIHRoZSBlcnJvciBjb25kaXRpb24gYXMgQ1NTIGNsYXNzIG5hbWVzCiAgICAgICAgZXJyQ2xhc3MgPSBlcnJDbGFzcyArICIgIiArICQubWFwKGFzQXJyYXkoZXJyLnR5cGUpLCBmdW5jdGlvbih0eXBlKSB7CiAgICAgICAgICByZXR1cm4gZXJyQ2xhc3MgKyAiLSIgKyB0eXBlOwogICAgICAgIH0pLmpvaW4oIiAiKTsKICAgICAgfQogICAgICBlcnJDbGFzcyA9IGVyckNsYXNzICsgIiBodG1sd2lkZ2V0cy1lcnJvciI7CgogICAgICAvLyBJcyBlbCBpbmxpbmUgb3IgYmxvY2s/IElmIGlubGluZSBvciBpbmxpbmUtYmxvY2ssIGp1c3QgZGlzcGxheTpub25lIGl0CiAgICAgIC8vIGFuZCBhZGQgYW4gaW5saW5lIGVycm9yLgogICAgICB2YXIgZGlzcGxheSA9ICRlbC5jc3MoImRpc3BsYXkiKTsKICAgICAgJGVsLmRhdGEoInJlc3RvcmUtZGlzcGxheS1tb2RlIiwgZGlzcGxheSk7CgogICAgICBpZiAoZGlzcGxheSA9PT0gImlubGluZSIgfHwgZGlzcGxheSA9PT0gImlubGluZS1ibG9jayIpIHsKICAgICAgICAkZWwuaGlkZSgpOwogICAgICAgIGlmIChlcnIubWVzc2FnZSAhPT0gIiIpIHsKICAgICAgICAgIHZhciBlcnJvclNwYW4gPSAkKCI8c3Bhbj4iKS5hZGRDbGFzcyhlcnJDbGFzcyk7CiAgICAgICAgICBlcnJvclNwYW4udGV4dChlcnIubWVzc2FnZSk7CiAgICAgICAgICAkZWwuYWZ0ZXIoZXJyb3JTcGFuKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoZGlzcGxheSA9PT0gImJsb2NrIikgewogICAgICAgIC8vIElmIGJsb2NrLCBhZGQgYW4gZXJyb3IganVzdCBhZnRlciB0aGUgZWwsIHNldCB2aXNpYmlsaXR5Om5vbmUgb24gdGhlCiAgICAgICAgLy8gZWwsIGFuZCBwb3NpdGlvbiB0aGUgZXJyb3IgdG8gYmUgb24gdG9wIG9mIHRoZSBlbC4KICAgICAgICAvLyBNYXJrIGl0IHdpdGggYSB1bmlxdWUgSUQgYW5kIENTUyBjbGFzcyBzbyB3ZSBjYW4gcmVtb3ZlIGl0IGxhdGVyLgogICAgICAgICRlbC5jc3MoInZpc2liaWxpdHkiLCAiaGlkZGVuIik7CiAgICAgICAgaWYgKGVyci5tZXNzYWdlICE9PSAiIikgewogICAgICAgICAgdmFyIGVycm9yRGl2ID0gJCgiPGRpdj4iKS5hZGRDbGFzcyhlcnJDbGFzcykuY3NzKCJwb3NpdGlvbiIsICJhYnNvbHV0ZSIpCiAgICAgICAgICAgIC5jc3MoInRvcCIsIGVsLm9mZnNldFRvcCkKICAgICAgICAgICAgLmNzcygibGVmdCIsIGVsLm9mZnNldExlZnQpCiAgICAgICAgICAgIC8vIHNldHRpbmcgd2lkdGggY2FuIHB1c2ggb3V0IHRoZSBwYWdlIHNpemUsIGZvcmNpbmcgb3RoZXJ3aXNlCiAgICAgICAgICAgIC8vIHVubmVjZXNzYXJ5IHNjcm9sbGJhcnMgdG8gYXBwZWFyIGFuZCBtYWtpbmcgaXQgaW1wb3NzaWJsZSBmb3IKICAgICAgICAgICAgLy8gdGhlIGVsZW1lbnQgdG8gc2hyaW5rOyBzbyB1c2UgbWF4LXdpZHRoIGluc3RlYWQKICAgICAgICAgICAgLmNzcygibWF4V2lkdGgiLCBlbC5vZmZzZXRXaWR0aCkKICAgICAgICAgICAgLmNzcygiaGVpZ2h0IiwgZWwub2Zmc2V0SGVpZ2h0KTsKICAgICAgICAgIGVycm9yRGl2LnRleHQoZXJyLm1lc3NhZ2UpOwogICAgICAgICAgJGVsLmFmdGVyKGVycm9yRGl2KTsKCiAgICAgICAgICAvLyBSZWFsbHkgZHVtYiB3YXkgdG8ga2VlcCB0aGUgc2l6ZS9wb3NpdGlvbiBvZiB0aGUgZXJyb3IgaW4gc3luYyB3aXRoCiAgICAgICAgICAvLyB0aGUgcGFyZW50IGVsZW1lbnQgYXMgdGhlIHdpbmRvdyBpcyByZXNpemVkIG9yIHdoYXRldmVyLgogICAgICAgICAgdmFyIGludElkID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghZXJyb3JEaXZbMF0ucGFyZW50RWxlbWVudCkgewogICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaW50SWQpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlcnJvckRpdgogICAgICAgICAgICAgIC5jc3MoInRvcCIsIGVsLm9mZnNldFRvcCkKICAgICAgICAgICAgICAuY3NzKCJsZWZ0IiwgZWwub2Zmc2V0TGVmdCkKICAgICAgICAgICAgICAuY3NzKCJtYXhXaWR0aCIsIGVsLm9mZnNldFdpZHRoKQogICAgICAgICAgICAgIC5jc3MoImhlaWdodCIsIGVsLm9mZnNldEhlaWdodCk7CiAgICAgICAgICB9LCA1MDApOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGNsZWFyRXJyb3I6IGZ1bmN0aW9uKGVsKSB7CiAgICAgIHZhciAkZWwgPSAkKGVsKTsKICAgICAgdmFyIGRpc3BsYXkgPSAkZWwuZGF0YSgicmVzdG9yZS1kaXNwbGF5LW1vZGUiKTsKICAgICAgJGVsLmRhdGEoInJlc3RvcmUtZGlzcGxheS1tb2RlIiwgbnVsbCk7CgogICAgICBpZiAoZGlzcGxheSA9PT0gImlubGluZSIgfHwgZGlzcGxheSA9PT0gImlubGluZS1ibG9jayIpIHsKICAgICAgICBpZiAoZGlzcGxheSkKICAgICAgICAgICRlbC5jc3MoImRpc3BsYXkiLCBkaXNwbGF5KTsKICAgICAgICAkKGVsLm5leHRTaWJsaW5nKS5maWx0ZXIoIi5odG1sd2lkZ2V0cy1lcnJvciIpLnJlbW92ZSgpOwogICAgICB9IGVsc2UgaWYgKGRpc3BsYXkgPT09ICJibG9jayIpewogICAgICAgICRlbC5jc3MoInZpc2liaWxpdHkiLCAiaW5oZXJpdCIpOwogICAgICAgICQoZWwubmV4dFNpYmxpbmcpLmZpbHRlcigiLmh0bWx3aWRnZXRzLWVycm9yIikucmVtb3ZlKCk7CiAgICAgIH0KICAgIH0sCiAgICBzaXppbmc6IHt9CiAgfTsKCiAgLy8gQ2FsbGVkIGJ5IHdpZGdldCBiaW5kaW5ncyB0byByZWdpc3RlciBhIG5ldyB0eXBlIG9mIHdpZGdldC4gVGhlIGRlZmluaXRpb24KICAvLyBvYmplY3QgY2FuIGNvbnRhaW4gdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogIC8vIC0gbmFtZSAocmVxdWlyZWQpIC0gQSBzdHJpbmcgaW5kaWNhdGluZyB0aGUgYmluZGluZyBuYW1lLCB3aGljaCB3aWxsIGJlCiAgLy8gICB1c2VkIGJ5IGRlZmF1bHQgYXMgdGhlIENTUyBjbGFzc25hbWUgdG8gbG9vayBmb3IuCiAgLy8gLSBpbml0aWFsaXplIChvcHRpb25hbCkgLSBBIGZ1bmN0aW9uKGVsKSB0aGF0IHdpbGwgYmUgY2FsbGVkIG9uY2UgcGVyCiAgLy8gICB3aWRnZXQgZWxlbWVudDsgaWYgYSB2YWx1ZSBpcyByZXR1cm5lZCwgaXQgd2lsbCBiZSBwYXNzZWQgYXMgdGhlIHRoaXJkCiAgLy8gICB2YWx1ZSB0byByZW5kZXJWYWx1ZS4KICAvLyAtIHJlbmRlclZhbHVlIChyZXF1aXJlZCkgLSBBIGZ1bmN0aW9uKGVsLCBkYXRhLCBpbml0VmFsdWUpIHRoYXQgd2lsbCBiZQogIC8vICAgY2FsbGVkIHdpdGggZGF0YS4gU3RhdGljIGNvbnRleHRzIHdpbGwgY2F1c2UgdGhpcyB0byBiZSBjYWxsZWQgb25jZSBwZXIKICAvLyAgIGVsZW1lbnQ7IFNoaW55IGFwcHMgd2lsbCBjYXVzZSB0aGlzIHRvIGJlIGNhbGxlZCBtdWx0aXBsZSB0aW1lcyBwZXIKICAvLyAgIGVsZW1lbnQsIGFzIHRoZSBkYXRhIGNoYW5nZXMuCiAgd2luZG93LkhUTUxXaWRnZXRzLndpZGdldCA9IGZ1bmN0aW9uKGRlZmluaXRpb24pIHsKICAgIGlmICghZGVmaW5pdGlvbi5uYW1lKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiV2lkZ2V0IG11c3QgaGF2ZSBhIG5hbWUiKTsKICAgIH0KICAgIGlmICghZGVmaW5pdGlvbi50eXBlKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiV2lkZ2V0IG11c3QgaGF2ZSBhIHR5cGUiKTsKICAgIH0KICAgIC8vIEN1cnJlbnRseSB3ZSBvbmx5IHN1cHBvcnQgb3V0cHV0IHdpZGdldHMKICAgIGlmIChkZWZpbml0aW9uLnR5cGUgIT09ICJvdXRwdXQiKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5yZWNvZ25pemVkIHdpZGdldCB0eXBlICciICsgZGVmaW5pdGlvbi50eXBlICsgIiciKTsKICAgIH0KICAgIC8vIFRPRE86IFZlcmlmeSB0aGF0IC5uYW1lIGlzIGEgdmFsaWQgQ1NTIGNsYXNzbmFtZQoKICAgIC8vIFN1cHBvcnQgbmV3LXN0eWxlIGluc3RhbmNlLWJvdW5kIGRlZmluaXRpb25zLiBPbGQtc3R5bGUgY2xhc3MtYm91bmQKICAgIC8vIGRlZmluaXRpb25zIGhhdmUgb25lIHdpZGdldCAib2JqZWN0IiBwZXIgd2lkZ2V0IHBlciB0eXBlL2NsYXNzIG9mCiAgICAvLyB3aWRnZXQ7IHRoZSByZW5kZXJWYWx1ZSBhbmQgcmVzaXplIG1ldGhvZHMgb24gc3VjaCB3aWRnZXQgb2JqZWN0cwogICAgLy8gdGFrZSBlbCBhbmQgaW5zdGFuY2UgYXJndW1lbnRzLCBiZWNhdXNlIHRoZSB3aWRnZXQgb2JqZWN0IGNhbid0CiAgICAvLyBzdG9yZSB0aGVtLiBOZXctc3R5bGUgaW5zdGFuY2UtYm91bmQgZGVmaW5pdGlvbnMgaGF2ZSBvbmUgd2lkZ2V0CiAgICAvLyBvYmplY3QgcGVyIHdpZGdldCBpbnN0YW5jZTsgdGhlIGRlZmluaXRpb24gdGhhdCdzIHBhc3NlZCBpbiBkb2Vzbid0CiAgICAvLyBwcm92aWRlIHJlbmRlclZhbHVlIG9yIHJlc2l6ZSBtZXRob2RzIGF0IGFsbCwganVzdCB0aGUgc2luZ2xlIG1ldGhvZAogICAgLy8gICBmYWN0b3J5KGVsLCB3aWR0aCwgaGVpZ2h0KQogICAgLy8gd2hpY2ggcmV0dXJucyBhbiBvYmplY3QgdGhhdCBoYXMgcmVuZGVyVmFsdWUoeCkgYW5kIHJlc2l6ZSh3LCBoKS4KICAgIC8vIFRoaXMgZW5hYmxlcyBhIGZhciBtb3JlIG5hdHVyYWwgcHJvZ3JhbW1pbmcgc3R5bGUgZm9yIHRoZSB3aWRnZXQKICAgIC8vIGF1dGhvciwgd2hvIGNhbiBzdG9yZSBwZXItaW5zdGFuY2Ugc3RhdGUgdXNpbmcgZWl0aGVyIE9PLXN0eWxlCiAgICAvLyBpbnN0YW5jZSBmaWVsZHMgb3IgZnVuY3Rpb25hbC1zdHlsZSBjbG9zdXJlIHZhcmlhYmxlcyAoSSBndWVzcyB0aGlzCiAgICAvLyBpcyBpbiBjb250cmFzdCB0byB3aGF0IGNhbiBvbmx5IGJlIGNhbGxlZCBDLXN0eWxlIHBzZXVkby1PTyB3aGljaCBpcwogICAgLy8gd2hhdCB3ZSByZXF1aXJlZCBiZWZvcmUpLgogICAgaWYgKGRlZmluaXRpb24uZmFjdG9yeSkgewogICAgICBkZWZpbml0aW9uID0gY3JlYXRlTGVnYWN5RGVmaW5pdGlvbkFkYXB0ZXIoZGVmaW5pdGlvbik7CiAgICB9CgogICAgaWYgKCFkZWZpbml0aW9uLnJlbmRlclZhbHVlKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiV2lkZ2V0IG11c3QgaGF2ZSBhIHJlbmRlclZhbHVlIGZ1bmN0aW9uIik7CiAgICB9CgogICAgLy8gRm9yIHN0YXRpYyByZW5kZXJpbmcgKG5vbi1TaGlueSksIHVzZSBhIHNpbXBsZSB3aWRnZXQgcmVnaXN0cmF0aW9uCiAgICAvLyBzY2hlbWUuIFdlIGFsc28gdXNlIHRoaXMgc2NoZW1lIGZvciBTaGlueSBhcHBzL2RvY3VtZW50cyB0aGF0IGFsc28KICAgIC8vIGNvbnRhaW4gc3RhdGljIHdpZGdldHMuCiAgICB3aW5kb3cuSFRNTFdpZGdldHMud2lkZ2V0cyA9IHdpbmRvdy5IVE1MV2lkZ2V0cy53aWRnZXRzIHx8IFtdOwogICAgLy8gTWVyZ2UgZGVmYXVsdHMgaW50byB0aGUgZGVmaW5pdGlvbjsgZG9uJ3QgbXV0YXRlIHRoZSBvcmlnaW5hbCBkZWZpbml0aW9uLgogICAgdmFyIHN0YXRpY0JpbmRpbmcgPSBleHRlbmQoe30sIGRlZmF1bHRzLCBkZWZpbml0aW9uKTsKICAgIG92ZXJyaWRlTWV0aG9kKHN0YXRpY0JpbmRpbmcsICJmaW5kIiwgZnVuY3Rpb24oc3VwZXJmdW5jKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSkgewogICAgICAgIHZhciByZXN1bHRzID0gc3VwZXJmdW5jKHNjb3BlKTsKICAgICAgICAvLyBGaWx0ZXIgb3V0IFNoaW55IG91dHB1dHMsIHdlIG9ubHkgd2FudCB0aGUgc3RhdGljIGtpbmQKICAgICAgICByZXR1cm4gZmlsdGVyQnlDbGFzcyhyZXN1bHRzLCAiaHRtbC13aWRnZXQtb3V0cHV0IiwgZmFsc2UpOwogICAgICB9OwogICAgfSk7CiAgICB3aW5kb3cuSFRNTFdpZGdldHMud2lkZ2V0cy5wdXNoKHN0YXRpY0JpbmRpbmcpOwoKICAgIGlmIChzaGlueU1vZGUpIHsKICAgICAgLy8gU2hpbnkgaXMgcnVubmluZy4gUmVnaXN0ZXIgdGhlIGRlZmluaXRpb24gd2l0aCBhbiBvdXRwdXQgYmluZGluZy4KICAgICAgLy8gVGhlIGRlZmluaXRpb24gaXRzZWxmIHdpbGwgbm90IGJlIHRoZSBvdXRwdXQgYmluZGluZywgaW5zdGVhZAogICAgICAvLyB3ZSB3aWxsIG1ha2UgYW4gb3V0cHV0IGJpbmRpbmcgb2JqZWN0IHRoYXQgZGVsZWdhdGVzIHRvIHRoZQogICAgICAvLyBkZWZpbml0aW9uLiBUaGlzIGlzIGJlY2F1c2Ugd2UgZm9vbGlzaGx5IHVzZWQgdGhlIHNhbWUgbWV0aG9kCiAgICAgIC8vIG5hbWUgKHJlbmRlclZhbHVlKSBmb3IgaHRtbHdpZGdldHMgZGVmaW5pdGlvbiBhbmQgU2hpbnkgYmluZGluZ3MKICAgICAgLy8gYnV0IHRoZXkgYWN0dWFsbHkgaGF2ZSBxdWl0ZSBkaWZmZXJlbnQgc2VtYW50aWNzICh0aGUgU2hpbnkKICAgICAgLy8gYmluZGluZ3MgcmVjZWl2ZSBkYXRhIHRoYXQgaW5jbHVkZXMgbG90cyBvZiBtZXRhZGF0YSB0aGF0IGl0CiAgICAgIC8vIHN0cmlwcyBvZmYgYmVmb3JlIGNhbGxpbmcgaHRtbHdpZGdldHMgcmVuZGVyVmFsdWUpLiBXZSBjYW4ndAogICAgICAvLyBqdXN0IGlnbm9yZSB0aGUgZGlmZmVyZW5jZSBiZWNhdXNlIGluIHNvbWUgd2lkZ2V0cyBpdCdzIGhlbHBmdWwKICAgICAgLy8gdG8gY2FsbCB0aGlzLnJlbmRlclZhbHVlKCkgZnJvbSBpbnNpZGUgb2YgcmVzaXplKCksIGFuZCBpZgogICAgICAvLyB3ZSdyZSBub3QgZGVsZWdhdGluZywgdGhlbiB0aGF0IGNhbGwgd2lsbCBnbyB0byB0aGUgU2hpbnkKICAgICAgLy8gdmVyc2lvbiBpbnN0ZWFkIG9mIHRoZSBodG1sd2lkZ2V0cyB2ZXJzaW9uLgoKICAgICAgLy8gTWVyZ2UgZGVmYXVsdHMgd2l0aCBkZWZpbml0aW9uLCB3aXRob3V0IG11dGF0aW5nIGVpdGhlci4KICAgICAgdmFyIGJpbmRpbmdEZWYgPSBleHRlbmQoe30sIGRlZmF1bHRzLCBkZWZpbml0aW9uKTsKCiAgICAgIC8vIFRoaXMgb2JqZWN0IHdpbGwgYmUgb3VyIGFjdHVhbCBTaGlueSBiaW5kaW5nLgogICAgICB2YXIgc2hpbnlCaW5kaW5nID0gbmV3IFNoaW55Lk91dHB1dEJpbmRpbmcoKTsKCiAgICAgIC8vIFdpdGggYSBmZXcgZXhjZXB0aW9ucywgd2UnbGwgd2FudCB0byBzaW1wbHkgdXNlIHRoZSBiaW5kaW5nRGVmJ3MKICAgICAgLy8gdmVyc2lvbiBvZiBtZXRob2RzIGlmIHRoZXkgYXJlIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGZhbGwgYmFjayB0bwogICAgICAvLyBTaGlueSdzIGRlZmF1bHRzLiBOT1RFOiBJZiBTaGlueSdzIG91dHB1dCBiaW5kaW5ncyBnYWluIGFkZGl0aW9uYWwKICAgICAgLy8gbWV0aG9kcyBpbiB0aGUgZnV0dXJlLCBhbmQgd2Ugd2FudCB0aGVtIHRvIGJlIG92ZXJyaWRlYWJsZSBieQogICAgICAvLyBIVE1MV2lkZ2V0IGJpbmRpbmcgZGVmaW5pdGlvbnMsIHRoZW4gd2UnbGwgbmVlZCB0byBhZGQgdGhlbSB0byB0aGlzCiAgICAgIC8vIGxpc3QuCiAgICAgIGRlbGVnYXRlTWV0aG9kKHNoaW55QmluZGluZywgYmluZGluZ0RlZiwgImdldElkIik7CiAgICAgIGRlbGVnYXRlTWV0aG9kKHNoaW55QmluZGluZywgYmluZGluZ0RlZiwgIm9uVmFsdWVDaGFuZ2UiKTsKICAgICAgZGVsZWdhdGVNZXRob2Qoc2hpbnlCaW5kaW5nLCBiaW5kaW5nRGVmLCAib25WYWx1ZUVycm9yIik7CiAgICAgIGRlbGVnYXRlTWV0aG9kKHNoaW55QmluZGluZywgYmluZGluZ0RlZiwgInJlbmRlckVycm9yIik7CiAgICAgIGRlbGVnYXRlTWV0aG9kKHNoaW55QmluZGluZywgYmluZGluZ0RlZiwgImNsZWFyRXJyb3IiKTsKICAgICAgZGVsZWdhdGVNZXRob2Qoc2hpbnlCaW5kaW5nLCBiaW5kaW5nRGVmLCAic2hvd1Byb2dyZXNzIik7CgogICAgICAvLyBUaGUgZmluZCwgcmVuZGVyVmFsdWUsIGFuZCByZXNpemUgYXJlIGhhbmRsZWQgZGlmZmVyZW50bHksIGJlY2F1c2Ugd2UKICAgICAgLy8gd2FudCB0byBhY3R1YWxseSBkZWNvcmF0ZSB0aGUgYmVoYXZpb3Igb2YgdGhlIGJpbmRpbmdEZWYgbWV0aG9kcy4KCiAgICAgIHNoaW55QmluZGluZy5maW5kID0gZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgICB2YXIgcmVzdWx0cyA9IGJpbmRpbmdEZWYuZmluZChzY29wZSk7CgogICAgICAgIC8vIE9ubHkgcmV0dXJuIGVsZW1lbnRzIHRoYXQgYXJlIFNoaW55IG91dHB1dHMsIG5vdCBzdGF0aWMgb25lcwogICAgICAgIHZhciBkeW5hbWljUmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKCIuaHRtbC13aWRnZXQtb3V0cHV0Iik7CgogICAgICAgIC8vIEl0J3MgcG9zc2libGUgdGhhdCB3aGF0ZXZlciBjYXVzZWQgU2hpbnkgdG8gdGhpbmsgdGhlcmUgbWlnaHQgYmUKICAgICAgICAvLyBuZXcgZHluYW1pYyBvdXRwdXRzLCBhbHNvIGNhdXNlZCB0aGVyZSB0byBiZSBuZXcgc3RhdGljIG91dHB1dHMuCiAgICAgICAgLy8gU2luY2UgdGhlcmUgbWlnaHQgYmUgbG90cyBvZiBkaWZmZXJlbnQgaHRtbHdpZGdldHMgYmluZGluZ3MsIHdlCiAgICAgICAgLy8gc2NoZWR1bGUgZXhlY3V0aW9uIGZvciBsYXRlci0tbm8gbmVlZCB0byBzdGF0aWNSZW5kZXIgbXVsdGlwbGUKICAgICAgICAvLyB0aW1lcy4KICAgICAgICBpZiAocmVzdWx0cy5sZW5ndGggIT09IGR5bmFtaWNSZXN1bHRzLmxlbmd0aCkKICAgICAgICAgIHNjaGVkdWxlU3RhdGljUmVuZGVyKCk7CgogICAgICAgIHJldHVybiBkeW5hbWljUmVzdWx0czsKICAgICAgfTsKCiAgICAgIC8vIFdyYXAgcmVuZGVyVmFsdWUgdG8gaGFuZGxlIGluaXRpYWxpemF0aW9uLCB3aGljaCB1bmZvcnR1bmF0ZWx5IGlzbid0CiAgICAgIC8vIHN1cHBvcnRlZCBuYXRpdmVseSBieSBTaGlueSBhdCB0aGUgdGltZSBvZiB0aGlzIHdyaXRpbmcuCgogICAgICBzaGlueUJpbmRpbmcucmVuZGVyVmFsdWUgPSBmdW5jdGlvbihlbCwgZGF0YSkgewogICAgICAgIFNoaW55LnJlbmRlckRlcGVuZGVuY2llcyhkYXRhLmRlcHMpOwogICAgICAgIC8vIFJlc29sdmUgc3RyaW5ncyBtYXJrZWQgYXMgamF2YXNjcmlwdCBsaXRlcmFscyB0byBvYmplY3RzCiAgICAgICAgaWYgKCEoZGF0YS5ldmFscyBpbnN0YW5jZW9mIEFycmF5KSkgZGF0YS5ldmFscyA9IFtkYXRhLmV2YWxzXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgZGF0YS5ldmFscyAmJiBpIDwgZGF0YS5ldmFscy5sZW5ndGg7IGkrKykgewogICAgICAgICAgd2luZG93LkhUTUxXaWRnZXRzLmV2YWx1YXRlU3RyaW5nTWVtYmVyKGRhdGEueCwgZGF0YS5ldmFsc1tpXSk7CiAgICAgICAgfQogICAgICAgIGlmICghYmluZGluZ0RlZi5yZW5kZXJPbk51bGxWYWx1ZSkgewogICAgICAgICAgaWYgKGRhdGEueCA9PT0gbnVsbCkgewogICAgICAgICAgICBlbC5zdHlsZS52aXNpYmlsaXR5ID0gImhpZGRlbiI7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGVsLnN0eWxlLnZpc2liaWxpdHkgPSAiaW5oZXJpdCI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghZWxlbWVudERhdGEoZWwsICJpbml0aWFsaXplZCIpKSB7CiAgICAgICAgICBpbml0U2l6aW5nKGVsKTsKCiAgICAgICAgICBlbGVtZW50RGF0YShlbCwgImluaXRpYWxpemVkIiwgdHJ1ZSk7CiAgICAgICAgICBpZiAoYmluZGluZ0RlZi5pbml0aWFsaXplKSB7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBiaW5kaW5nRGVmLmluaXRpYWxpemUoZWwsIGVsLm9mZnNldFdpZHRoLAogICAgICAgICAgICAgIGVsLm9mZnNldEhlaWdodCk7CiAgICAgICAgICAgIGVsZW1lbnREYXRhKGVsLCAiaW5pdF9yZXN1bHQiLCByZXN1bHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBiaW5kaW5nRGVmLnJlbmRlclZhbHVlKGVsLCBkYXRhLngsIGVsZW1lbnREYXRhKGVsLCAiaW5pdF9yZXN1bHQiKSk7CiAgICAgICAgZXZhbEFuZFJ1bihkYXRhLmpzSG9va3MucmVuZGVyLCBlbGVtZW50RGF0YShlbCwgImluaXRfcmVzdWx0IiksIFtlbCwgZGF0YS54XSk7CiAgICAgIH07CgogICAgICAvLyBPbmx5IG92ZXJyaWRlIHJlc2l6ZSBpZiBiaW5kaW5nRGVmIGltcGxlbWVudHMgaXQKICAgICAgaWYgKGJpbmRpbmdEZWYucmVzaXplKSB7CiAgICAgICAgc2hpbnlCaW5kaW5nLnJlc2l6ZSA9IGZ1bmN0aW9uKGVsLCB3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgICAvLyBTaGlueSBjYW4gY2FsbCByZXNpemUgYmVmb3JlIGluaXRpYWxpemUvcmVuZGVyVmFsdWUgaGF2ZSBiZWVuCiAgICAgICAgICAvLyBjYWxsZWQsIHdoaWNoIGRvZXNuJ3QgbWFrZSBzZW5zZSBmb3Igd2lkZ2V0cy4KICAgICAgICAgIGlmIChlbGVtZW50RGF0YShlbCwgImluaXRpYWxpemVkIikpIHsKICAgICAgICAgICAgYmluZGluZ0RlZi5yZXNpemUoZWwsIHdpZHRoLCBoZWlnaHQsIGVsZW1lbnREYXRhKGVsLCAiaW5pdF9yZXN1bHQiKSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgU2hpbnkub3V0cHV0QmluZGluZ3MucmVnaXN0ZXIoc2hpbnlCaW5kaW5nLCBiaW5kaW5nRGVmLm5hbWUpOwogICAgfQogIH07CgogIHZhciBzY2hlZHVsZVN0YXRpY1JlbmRlclRpbWVySWQgPSBudWxsOwogIGZ1bmN0aW9uIHNjaGVkdWxlU3RhdGljUmVuZGVyKCkgewogICAgaWYgKCFzY2hlZHVsZVN0YXRpY1JlbmRlclRpbWVySWQpIHsKICAgICAgc2NoZWR1bGVTdGF0aWNSZW5kZXJUaW1lcklkID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICBzY2hlZHVsZVN0YXRpY1JlbmRlclRpbWVySWQgPSBudWxsOwogICAgICAgIHdpbmRvdy5IVE1MV2lkZ2V0cy5zdGF0aWNSZW5kZXIoKTsKICAgICAgfSwgMSk7CiAgICB9CiAgfQoKICAvLyBSZW5kZXIgc3RhdGljIHdpZGdldHMgYWZ0ZXIgdGhlIGRvY3VtZW50IGZpbmlzaGVzIGxvYWRpbmcKICAvLyBTdGF0aWNhbGx5IHJlbmRlciBhbGwgZWxlbWVudHMgdGhhdCBhcmUgb2YgdGhpcyB3aWRnZXQncyBjbGFzcwogIHdpbmRvdy5IVE1MV2lkZ2V0cy5zdGF0aWNSZW5kZXIgPSBmdW5jdGlvbigpIHsKICAgIHZhciBiaW5kaW5ncyA9IHdpbmRvdy5IVE1MV2lkZ2V0cy53aWRnZXRzIHx8IFtdOwogICAgZm9yRWFjaChiaW5kaW5ncywgZnVuY3Rpb24oYmluZGluZykgewogICAgICB2YXIgbWF0Y2hlcyA9IGJpbmRpbmcuZmluZChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpOwogICAgICBmb3JFYWNoKG1hdGNoZXMsIGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgdmFyIHNpemVPYmogPSBpbml0U2l6aW5nKGVsLCBiaW5kaW5nKTsKCiAgICAgICAgaWYgKGhhc0NsYXNzKGVsLCAiaHRtbC13aWRnZXQtc3RhdGljLWJvdW5kIikpCiAgICAgICAgICByZXR1cm47CiAgICAgICAgZWwuY2xhc3NOYW1lID0gZWwuY2xhc3NOYW1lICsgIiBodG1sLXdpZGdldC1zdGF0aWMtYm91bmQiOwoKICAgICAgICB2YXIgaW5pdFJlc3VsdDsKICAgICAgICBpZiAoYmluZGluZy5pbml0aWFsaXplKSB7CiAgICAgICAgICBpbml0UmVzdWx0ID0gYmluZGluZy5pbml0aWFsaXplKGVsLAogICAgICAgICAgICBzaXplT2JqID8gc2l6ZU9iai5nZXRXaWR0aCgpIDogZWwub2Zmc2V0V2lkdGgsCiAgICAgICAgICAgIHNpemVPYmogPyBzaXplT2JqLmdldEhlaWdodCgpIDogZWwub2Zmc2V0SGVpZ2h0CiAgICAgICAgICApOwogICAgICAgICAgZWxlbWVudERhdGEoZWwsICJpbml0X3Jlc3VsdCIsIGluaXRSZXN1bHQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGJpbmRpbmcucmVzaXplKSB7CiAgICAgICAgICB2YXIgbGFzdFNpemUgPSB7fTsKICAgICAgICAgIHZhciByZXNpemVIYW5kbGVyID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICB2YXIgc2l6ZSA9IHsKICAgICAgICAgICAgICB3OiBzaXplT2JqID8gc2l6ZU9iai5nZXRXaWR0aCgpIDogZWwub2Zmc2V0V2lkdGgsCiAgICAgICAgICAgICAgaDogc2l6ZU9iaiA/IHNpemVPYmouZ2V0SGVpZ2h0KCkgOiBlbC5vZmZzZXRIZWlnaHQKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHNpemUudyA9PT0gMCAmJiBzaXplLmggPT09IDApCiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBpZiAoc2l6ZS53ID09PSBsYXN0U2l6ZS53ICYmIHNpemUuaCA9PT0gbGFzdFNpemUuaCkKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGxhc3RTaXplID0gc2l6ZTsKICAgICAgICAgICAgYmluZGluZy5yZXNpemUoZWwsIHNpemUudywgc2l6ZS5oLCBpbml0UmVzdWx0KTsKICAgICAgICAgIH07CgogICAgICAgICAgb24od2luZG93LCAicmVzaXplIiwgcmVzaXplSGFuZGxlcik7CgogICAgICAgICAgLy8gVGhpcyBpcyBuZWVkZWQgZm9yIGNhc2VzIHdoZXJlIHdlJ3JlIHJ1bm5pbmcgaW4gYSBTaGlueQogICAgICAgICAgLy8gYXBwLCBidXQgdGhlIHdpZGdldCBpdHNlbGYgaXMgbm90IGEgU2hpbnkgb3V0cHV0LCBidXQKICAgICAgICAgIC8vIHJhdGhlciBhIHNpbXBsZSBzdGF0aWMgd2lkZ2V0LiBPbmUgZXhhbXBsZSBvZiB0aGlzIGlzCiAgICAgICAgICAvLyBhbiBybWFya2Rvd24gZG9jdW1lbnQgdGhhdCBoYXMgcnVudGltZTpzaGlueSBhbmQgd2lkZ2V0CiAgICAgICAgICAvLyB0aGF0IGlzbid0IGluIGEgcmVuZGVyIGZ1bmN0aW9uLiBTaGlueSBvbmx5IGtub3dzIHRvCiAgICAgICAgICAvLyBjYWxsIHJlc2l6ZSBoYW5kbGVycyBmb3IgU2hpbnkgb3V0cHV0cywgbm90IGZvciBzdGF0aWMKICAgICAgICAgIC8vIHdpZGdldHMsIHNvIHdlIGRvIGl0IG91cnNlbHZlcy4KICAgICAgICAgIGlmICh3aW5kb3cualF1ZXJ5KSB7CiAgICAgICAgICAgIHdpbmRvdy5qUXVlcnkoZG9jdW1lbnQpLm9uKAogICAgICAgICAgICAgICJzaG93bi5odG1sd2lkZ2V0cyBzaG93bi5icy50YWIuaHRtbHdpZGdldHMgc2hvd24uYnMuY29sbGFwc2UuaHRtbHdpZGdldHMiLAogICAgICAgICAgICAgIHJlc2l6ZUhhbmRsZXIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgd2luZG93LmpRdWVyeShkb2N1bWVudCkub24oCiAgICAgICAgICAgICAgImhpZGRlbi5odG1sd2lkZ2V0cyBoaWRkZW4uYnMudGFiLmh0bWx3aWRnZXRzIGhpZGRlbi5icy5jb2xsYXBzZS5odG1sd2lkZ2V0cyIsCiAgICAgICAgICAgICAgcmVzaXplSGFuZGxlcgogICAgICAgICAgICApOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFRoaXMgaXMgbmVlZGVkIGZvciB0aGUgc3BlY2lmaWMgY2FzZSBvZiBpb3NsaWRlcywgd2hpY2gKICAgICAgICAgIC8vIGZsaXBzIHNsaWRlcyBiZXR3ZWVuIGRpc3BsYXk6bm9uZSBhbmQgZGlzcGxheTpibG9jay4KICAgICAgICAgIC8vIElkZWFsbHkgd2Ugd291bGQgbm90IGhhdmUgdG8gaGF2ZSBpb3NsaWRlLXNwZWNpZmljIGNvZGUKICAgICAgICAgIC8vIGhlcmUsIGJ1dCByYXRoZXIgaGF2ZSBpb3NsaWRlcyByYWlzZSBhIGdlbmVyaWMgZXZlbnQsCiAgICAgICAgICAvLyBidXQgdGhlIHJtYXJrZG93biBwYWNrYWdlIGp1c3Qgd2VudCB0byBDUkFOIHNvIHRoZQogICAgICAgICAgLy8gd2luZG93IHRvIGdldHRpbmcgdGhhdCBmaXhlZCBtYXkgYmUgbG9uZy4KICAgICAgICAgIGlmICh3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcikgewogICAgICAgICAgICAvLyBJdCdzIE9LIHRvIGxpbWl0IHRoaXMgdG8gd2luZG93LmFkZEV2ZW50TGlzdGVuZXIKICAgICAgICAgICAgLy8gYnJvd3NlcnMgYmVjYXVzZSBpb3NsaWRlcyBpdHNlbGYgb25seSBzdXBwb3J0cwogICAgICAgICAgICAvLyBzdWNoIGJyb3dzZXJzLgogICAgICAgICAgICBvbihkb2N1bWVudCwgInNsaWRlZW50ZXIiLCByZXNpemVIYW5kbGVyKTsKICAgICAgICAgICAgb24oZG9jdW1lbnQsICJzbGlkZWxlYXZlIiwgcmVzaXplSGFuZGxlcik7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgc2NyaXB0RGF0YSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoInNjcmlwdFtkYXRhLWZvcj0nIiArIGVsLmlkICsgIiddW3R5cGU9J2FwcGxpY2F0aW9uL2pzb24nXSIpOwogICAgICAgIGlmIChzY3JpcHREYXRhKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IEpTT04ucGFyc2Uoc2NyaXB0RGF0YS50ZXh0Q29udGVudCB8fCBzY3JpcHREYXRhLnRleHQpOwogICAgICAgICAgLy8gUmVzb2x2ZSBzdHJpbmdzIG1hcmtlZCBhcyBqYXZhc2NyaXB0IGxpdGVyYWxzIHRvIG9iamVjdHMKICAgICAgICAgIGlmICghKGRhdGEuZXZhbHMgaW5zdGFuY2VvZiBBcnJheSkpIGRhdGEuZXZhbHMgPSBbZGF0YS5ldmFsc107CiAgICAgICAgICBmb3IgKHZhciBrID0gMDsgZGF0YS5ldmFscyAmJiBrIDwgZGF0YS5ldmFscy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICB3aW5kb3cuSFRNTFdpZGdldHMuZXZhbHVhdGVTdHJpbmdNZW1iZXIoZGF0YS54LCBkYXRhLmV2YWxzW2tdKTsKICAgICAgICAgIH0KICAgICAgICAgIGJpbmRpbmcucmVuZGVyVmFsdWUoZWwsIGRhdGEueCwgaW5pdFJlc3VsdCk7CiAgICAgICAgICBldmFsQW5kUnVuKGRhdGEuanNIb29rcy5yZW5kZXIsIGluaXRSZXN1bHQsIFtlbCwgZGF0YS54XSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwoKICAgIGludm9rZVBvc3RSZW5kZXJIYW5kbGVycygpOwogIH0KCiAgLy8gV2FpdCB1bnRpbCBhZnRlciB0aGUgZG9jdW1lbnQgaGFzIGxvYWRlZCB0byByZW5kZXIgdGhlIHdpZGdldHMuCiAgaWYgKGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCBmdW5jdGlvbigpIHsKICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIGFyZ3VtZW50cy5jYWxsZWUsIGZhbHNlKTsKICAgICAgd2luZG93LkhUTUxXaWRnZXRzLnN0YXRpY1JlbmRlcigpOwogICAgfSwgZmFsc2UpOwogIH0gZWxzZSBpZiAoZG9jdW1lbnQuYXR0YWNoRXZlbnQpIHsKICAgIGRvY3VtZW50LmF0dGFjaEV2ZW50KCJvbnJlYWR5c3RhdGVjaGFuZ2UiLCBmdW5jdGlvbigpIHsKICAgICAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIpIHsKICAgICAgICBkb2N1bWVudC5kZXRhY2hFdmVudCgib25yZWFkeXN0YXRlY2hhbmdlIiwgYXJndW1lbnRzLmNhbGxlZSk7CiAgICAgICAgd2luZG93LkhUTUxXaWRnZXRzLnN0YXRpY1JlbmRlcigpOwogICAgICB9CiAgICB9KTsKICB9CgoKICB3aW5kb3cuSFRNTFdpZGdldHMuZ2V0QXR0YWNobWVudFVybCA9IGZ1bmN0aW9uKGRlcG5hbWUsIGtleSkgewogICAgLy8gSWYgbm8ga2V5LCBkZWZhdWx0IHRvIHRoZSBmaXJzdCBpdGVtCiAgICBpZiAodHlwZW9mKGtleSkgPT09ICJ1bmRlZmluZWQiKQogICAgICBrZXkgPSAxOwoKICAgIHZhciBsaW5rID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZGVwbmFtZSArICItIiArIGtleSArICItYXR0YWNobWVudCIpOwogICAgaWYgKCFsaW5rKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiQXR0YWNobWVudCAiICsgZGVwbmFtZSArICIvIiArIGtleSArICIgbm90IGZvdW5kIGluIGRvY3VtZW50Iik7CiAgICB9CiAgICByZXR1cm4gbGluay5nZXRBdHRyaWJ1dGUoImhyZWYiKTsKICB9OwoKICB3aW5kb3cuSFRNTFdpZGdldHMuZGF0YWZyYW1lVG9EMyA9IGZ1bmN0aW9uKGRmKSB7CiAgICB2YXIgbmFtZXMgPSBbXTsKICAgIHZhciBsZW5ndGg7CiAgICBmb3IgKHZhciBuYW1lIGluIGRmKSB7CiAgICAgICAgaWYgKGRmLmhhc093blByb3BlcnR5KG5hbWUpKQogICAgICAgICAgICBuYW1lcy5wdXNoKG5hbWUpOwogICAgICAgIGlmICh0eXBlb2YoZGZbbmFtZV0pICE9PSAib2JqZWN0IiB8fCB0eXBlb2YoZGZbbmFtZV0ubGVuZ3RoKSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbGwgZmllbGRzIG11c3QgYmUgYXJyYXlzIik7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YobGVuZ3RoKSAhPT0gInVuZGVmaW5lZCIgJiYgbGVuZ3RoICE9PSBkZltuYW1lXS5sZW5ndGgpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbGwgZmllbGRzIG11c3QgYmUgYXJyYXlzIG9mIHRoZSBzYW1lIGxlbmd0aCIpOwogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBkZltuYW1lXS5sZW5ndGg7CiAgICB9CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgdmFyIGl0ZW07CiAgICBmb3IgKHZhciByb3cgPSAwOyByb3cgPCBsZW5ndGg7IHJvdysrKSB7CiAgICAgICAgaXRlbSA9IHt9OwogICAgICAgIGZvciAodmFyIGNvbCA9IDA7IGNvbCA8IG5hbWVzLmxlbmd0aDsgY29sKyspIHsKICAgICAgICAgICAgaXRlbVtuYW1lc1tjb2xdXSA9IGRmW25hbWVzW2NvbF1dW3Jvd107CiAgICAgICAgfQogICAgICAgIHJlc3VsdHMucHVzaChpdGVtKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIHdpbmRvdy5IVE1MV2lkZ2V0cy50cmFuc3Bvc2VBcnJheTJEID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgICAgaWYgKGFycmF5Lmxlbmd0aCA9PT0gMCkgcmV0dXJuIGFycmF5OwogICAgICB2YXIgbmV3QXJyYXkgPSBhcnJheVswXS5tYXAoZnVuY3Rpb24oY29sLCBpKSB7CiAgICAgICAgICByZXR1cm4gYXJyYXkubWFwKGZ1bmN0aW9uKHJvdykgewogICAgICAgICAgICAgIHJldHVybiByb3dbaV0KICAgICAgICAgIH0pCiAgICAgIH0pOwogICAgICByZXR1cm4gbmV3QXJyYXk7CiAgfTsKICAvLyBTcGxpdCB2YWx1ZSBhdCBzcGxpdENoYXIsIGJ1dCBhbGxvdyBzcGxpdENoYXIgdG8gYmUgZXNjYXBlZAogIC8vIHVzaW5nIGVzY2FwZUNoYXIuIEFueSBvdGhlciBjaGFyYWN0ZXJzIGVzY2FwZWQgYnkgZXNjYXBlQ2hhcgogIC8vIHdpbGwgYmUgaW5jbHVkZWQgYXMgdXN1YWwgKGluY2x1ZGluZyBlc2NhcGVDaGFyIGl0c2VsZikuCiAgZnVuY3Rpb24gc3BsaXRXaXRoRXNjYXBlKHZhbHVlLCBzcGxpdENoYXIsIGVzY2FwZUNoYXIpIHsKICAgIHZhciByZXN1bHRzID0gW107CiAgICB2YXIgZXNjYXBlTW9kZSA9IGZhbHNlOwogICAgdmFyIGN1cnJlbnRSZXN1bHQgPSAiIjsKICAgIGZvciAodmFyIHBvcyA9IDA7IHBvcyA8IHZhbHVlLmxlbmd0aDsgcG9zKyspIHsKICAgICAgaWYgKCFlc2NhcGVNb2RlKSB7CiAgICAgICAgaWYgKHZhbHVlW3Bvc10gPT09IHNwbGl0Q2hhcikgewogICAgICAgICAgcmVzdWx0cy5wdXNoKGN1cnJlbnRSZXN1bHQpOwogICAgICAgICAgY3VycmVudFJlc3VsdCA9ICIiOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWVbcG9zXSA9PT0gZXNjYXBlQ2hhcikgewogICAgICAgICAgZXNjYXBlTW9kZSA9IHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN1cnJlbnRSZXN1bHQgKz0gdmFsdWVbcG9zXTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY3VycmVudFJlc3VsdCArPSB2YWx1ZVtwb3NdOwogICAgICAgIGVzY2FwZU1vZGUgPSBmYWxzZTsKICAgICAgfQogICAgfQogICAgaWYgKGN1cnJlbnRSZXN1bHQgIT09ICIiKSB7CiAgICAgIHJlc3VsdHMucHVzaChjdXJyZW50UmVzdWx0KTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH0KICAvLyBGdW5jdGlvbiBhdXRob3JlZCBieSBZaWh1aS9KSiBBbGxhaXJlCiAgd2luZG93LkhUTUxXaWRnZXRzLmV2YWx1YXRlU3RyaW5nTWVtYmVyID0gZnVuY3Rpb24obywgbWVtYmVyKSB7CiAgICB2YXIgcGFydHMgPSBzcGxpdFdpdGhFc2NhcGUobWVtYmVyLCAnLicsICdcXCcpOwogICAgZm9yICh2YXIgaSA9IDAsIGwgPSBwYXJ0cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgdmFyIHBhcnQgPSBwYXJ0c1tpXTsKICAgICAgLy8gcGFydCBtYXkgYmUgYSBjaGFyYWN0ZXIgb3IgJ251bWVyaWMnIG1lbWJlciBuYW1lCiAgICAgIGlmIChvICE9PSBudWxsICYmIHR5cGVvZiBvID09PSAib2JqZWN0IiAmJiBwYXJ0IGluIG8pIHsKICAgICAgICBpZiAoaSA9PSAobCAtIDEpKSB7IC8vIGlmIHdlIGFyZSBhdCB0aGUgZW5kIG9mIHRoZSBsaW5lIHRoZW4gZXZhbHVsYXRlCiAgICAgICAgICBpZiAodHlwZW9mIG9bcGFydF0gPT09ICJzdHJpbmciKQogICAgICAgICAgICBvW3BhcnRdID0gZXZhbCgiKCIgKyBvW3BhcnRdICsgIikiKTsKICAgICAgICB9IGVsc2UgeyAvLyBvdGhlcndpc2UgY29udGludWUgdG8gbmV4dCBlbWJlZGRlZCBvYmplY3QKICAgICAgICAgIG8gPSBvW3BhcnRdOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH07CgogIC8vIFJldHJpZXZlIHRoZSBIVE1MV2lkZ2V0IGluc3RhbmNlIChpLmUuIHRoZSByZXR1cm4gdmFsdWUgb2YgYW4KICAvLyBIVE1MV2lkZ2V0IGJpbmRpbmcncyBpbml0aWFsaXplKCkgb3IgZmFjdG9yeSgpIGZ1bmN0aW9uKQogIC8vIGFzc29jaWF0ZWQgd2l0aCBhbiBlbGVtZW50LCBvciBudWxsIGlmIG5vbmUuCiAgd2luZG93LkhUTUxXaWRnZXRzLmdldEluc3RhbmNlID0gZnVuY3Rpb24oZWwpIHsKICAgIHJldHVybiBlbGVtZW50RGF0YShlbCwgImluaXRfcmVzdWx0Iik7CiAgfTsKCiAgLy8gRmluZHMgdGhlIGZpcnN0IGVsZW1lbnQgaW4gdGhlIHNjb3BlIHRoYXQgbWF0Y2hlcyB0aGUgc2VsZWN0b3IsCiAgLy8gYW5kIHJldHVybnMgdGhlIEhUTUxXaWRnZXQgaW5zdGFuY2UgKGkuZS4gdGhlIHJldHVybiB2YWx1ZSBvZgogIC8vIGFuIEhUTUxXaWRnZXQgYmluZGluZydzIGluaXRpYWxpemUoKSBvciBmYWN0b3J5KCkgZnVuY3Rpb24pCiAgLy8gYXNzb2NpYXRlZCB3aXRoIHRoYXQgZWxlbWVudCwgaWYgYW55LiBJZiBubyBlbGVtZW50IG1hdGNoZXMgdGhlCiAgLy8gc2VsZWN0b3IsIG9yIHRoZSBmaXJzdCBtYXRjaGluZyBlbGVtZW50IGhhcyBubyBIVE1MV2lkZ2V0CiAgLy8gaW5zdGFuY2UgYXNzb2NpYXRlZCB3aXRoIGl0LCB0aGVuIG51bGwgaXMgcmV0dXJuZWQuCiAgLy8KICAvLyBUaGUgc2NvcGUgYXJndW1lbnQgaXMgb3B0aW9uYWwsIGFuZCBkZWZhdWx0cyB0byB3aW5kb3cuZG9jdW1lbnQuCiAgd2luZG93LkhUTUxXaWRnZXRzLmZpbmQgPSBmdW5jdGlvbihzY29wZSwgc2VsZWN0b3IpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKICAgICAgc2VsZWN0b3IgPSBzY29wZTsKICAgICAgc2NvcGUgPSBkb2N1bWVudDsKICAgIH0KCiAgICB2YXIgZWwgPSBzY29wZS5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKTsKICAgIGlmIChlbCA9PT0gbnVsbCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB3aW5kb3cuSFRNTFdpZGdldHMuZ2V0SW5zdGFuY2UoZWwpOwogICAgfQogIH07CgogIC8vIEZpbmRzIGFsbCBlbGVtZW50cyBpbiB0aGUgc2NvcGUgdGhhdCBtYXRjaCB0aGUgc2VsZWN0b3IsIGFuZAogIC8vIHJldHVybnMgdGhlIEhUTUxXaWRnZXQgaW5zdGFuY2VzIChpLmUuIHRoZSByZXR1cm4gdmFsdWVzIG9mCiAgLy8gYW4gSFRNTFdpZGdldCBiaW5kaW5nJ3MgaW5pdGlhbGl6ZSgpIG9yIGZhY3RvcnkoKSBmdW5jdGlvbikKICAvLyBhc3NvY2lhdGVkIHdpdGggdGhlIGVsZW1lbnRzLCBpbiBhbiBhcnJheS4gSWYgZWxlbWVudHMgdGhhdAogIC8vIG1hdGNoIHRoZSBzZWxlY3RvciBkb24ndCBoYXZlIGFuIGFzc29jaWF0ZWQgSFRNTFdpZGdldAogIC8vIGluc3RhbmNlLCB0aGUgcmV0dXJuZWQgYXJyYXkgd2lsbCBjb250YWluIG51bGxzLgogIC8vCiAgLy8gVGhlIHNjb3BlIGFyZ3VtZW50IGlzIG9wdGlvbmFsLCBhbmQgZGVmYXVsdHMgdG8gd2luZG93LmRvY3VtZW50LgogIHdpbmRvdy5IVE1MV2lkZ2V0cy5maW5kQWxsID0gZnVuY3Rpb24oc2NvcGUsIHNlbGVjdG9yKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CiAgICAgIHNlbGVjdG9yID0gc2NvcGU7CiAgICAgIHNjb3BlID0gZG9jdW1lbnQ7CiAgICB9CgogICAgdmFyIG5vZGVzID0gc2NvcGUucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvcik7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2Rlcy5sZW5ndGg7IGkrKykgewogICAgICByZXN1bHRzLnB1c2god2luZG93LkhUTUxXaWRnZXRzLmdldEluc3RhbmNlKG5vZGVzW2ldKSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICB2YXIgcG9zdFJlbmRlckhhbmRsZXJzID0gW107CiAgZnVuY3Rpb24gaW52b2tlUG9zdFJlbmRlckhhbmRsZXJzKCkgewogICAgd2hpbGUgKHBvc3RSZW5kZXJIYW5kbGVycy5sZW5ndGgpIHsKICAgICAgdmFyIGhhbmRsZXIgPSBwb3N0UmVuZGVySGFuZGxlcnMuc2hpZnQoKTsKICAgICAgaWYgKGhhbmRsZXIpIHsKICAgICAgICBoYW5kbGVyKCk7CiAgICAgIH0KICAgIH0KICB9CgogIC8vIFJlZ2lzdGVyIHRoZSBnaXZlbiBjYWxsYmFjayBmdW5jdGlvbiB0byBiZSBpbnZva2VkIGFmdGVyIHRoZQogIC8vIG5leHQgdGltZSBzdGF0aWMgd2lkZ2V0cyBhcmUgcmVuZGVyZWQuCiAgd2luZG93LkhUTUxXaWRnZXRzLmFkZFBvc3RSZW5kZXJIYW5kbGVyID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgIHBvc3RSZW5kZXJIYW5kbGVycy5wdXNoKGNhbGxiYWNrKTsKICB9OwoKICAvLyBUYWtlcyBhIG5ldy1zdHlsZSBpbnN0YW5jZS1ib3VuZCBkZWZpbml0aW9uLCBhbmQgcmV0dXJucyBhbgogIC8vIG9sZC1zdHlsZSBjbGFzcy1ib3VuZCBkZWZpbml0aW9uLiBUaGlzIHNhdmVzIHVzIGZyb20gaGF2aW5nCiAgLy8gdG8gcmV3cml0ZSBhbGwgdGhlIGxvZ2ljIGluIHRoaXMgZmlsZSB0byBhY2NvbW9kYXRlIGJvdGgKICAvLyB0eXBlcyBvZiBkZWZpbml0aW9ucy4KICBmdW5jdGlvbiBjcmVhdGVMZWdhY3lEZWZpbml0aW9uQWRhcHRlcihkZWZuKSB7CiAgICB2YXIgcmVzdWx0ID0gewogICAgICBuYW1lOiBkZWZuLm5hbWUsCiAgICAgIHR5cGU6IGRlZm4udHlwZSwKICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWwsIHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICByZXR1cm4gZGVmbi5mYWN0b3J5KGVsLCB3aWR0aCwgaGVpZ2h0KTsKICAgICAgfSwKICAgICAgcmVuZGVyVmFsdWU6IGZ1bmN0aW9uKGVsLCB4LCBpbnN0YW5jZSkgewogICAgICAgIHJldHVybiBpbnN0YW5jZS5yZW5kZXJWYWx1ZSh4KTsKICAgICAgfSwKICAgICAgcmVzaXplOiBmdW5jdGlvbihlbCwgd2lkdGgsIGhlaWdodCwgaW5zdGFuY2UpIHsKICAgICAgICByZXR1cm4gaW5zdGFuY2UucmVzaXplKHdpZHRoLCBoZWlnaHQpOwogICAgICB9CiAgICB9OwoKICAgIGlmIChkZWZuLmZpbmQpCiAgICAgIHJlc3VsdC5maW5kID0gZGVmbi5maW5kOwogICAgaWYgKGRlZm4ucmVuZGVyRXJyb3IpCiAgICAgIHJlc3VsdC5yZW5kZXJFcnJvciA9IGRlZm4ucmVuZGVyRXJyb3I7CiAgICBpZiAoZGVmbi5jbGVhckVycm9yKQogICAgICByZXN1bHQuY2xlYXJFcnJvciA9IGRlZm4uY2xlYXJFcnJvcjsKCiAgICByZXR1cm4gcmVzdWx0OwogIH0KfSkoKTsKCg=="></script>
<link href="data:text/css;charset=utf-8,svg%2Erailroad%2Ddiagram%20%7B%0Abackground%2Dcolor%3A%20hsl%2830%2C20%25%2C95%25%29%3B%0A%7D%0Asvg%2Erailroad%2Ddiagram%20path%20%7B%0Astroke%2Dwidth%3A%203%3B%0Astroke%3A%20black%3B%0Afill%3A%20rgba%280%2C0%2C0%2C0%29%3B%0A%7D%0Asvg%2Erailroad%2Ddiagram%20text%20%7B%0Afont%3A%20bold%2014px%20monospace%3B%0Atext%2Danchor%3A%20middle%3B%0A%7D%0Asvg%2Erailroad%2Ddiagram%20text%2Elabel%20%7B%0Atext%2Danchor%3A%20start%3B%0A%7D%0Asvg%2Erailroad%2Ddiagram%20text%2Ecomment%20%7B%0Afont%3A%20italic%2012px%20monospace%3B%0A%7D%0Asvg%2Erailroad%2Ddiagram%20g%2Enon%2Dterminal%20text%20%7B%0A%0A%7D%0Asvg%2Erailroad%2Ddiagram%20rect%20%7B%0Astroke%2Dwidth%3A%203%3B%0Astroke%3A%20black%3B%0Afill%3A%20hsl%28120%2C100%25%2C90%25%29%3B%0A%7D%0A" rel="stylesheet" />
<script src="data:application/x-javascript;base64,LyoKUmFpbHJvYWQgRGlhZ3JhbXMKYnkgVGFiIEF0a2lucyBKci4gKGFuZCBvdGhlcnMpCmh0dHA6Ly94YW50aGlyLmNvbQpodHRwOi8vdHdpdHRlci5jb20vdGFiYXRraW5zCmh0dHA6Ly9naXRodWIuY29tL3RhYmF0a2lucy9yYWlscm9hZC1kaWFncmFtcwoKVGhpcyBkb2N1bWVudCBhbmQgYWxsIGFzc29jaWF0ZWQgZmlsZXMgaW4gdGhlIGdpdGh1YiBwcm9qZWN0IGFyZSBsaWNlbnNlZCB1bmRlciBDQzA6IGh0dHA6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL3B1YmxpY2RvbWFpbi96ZXJvLzEuMC8KVGhpcyBtZWFucyB5b3UgY2FuIHJldXNlLCByZW1peCwgb3Igb3RoZXJ3aXNlIGFwcHJvcHJpYXRlIHRoaXMgcHJvamVjdCBmb3IgeW91ciBvd24gdXNlIFdJVEhPVVQgUkVTVFJJQ1RJT04uCihUaGUgYWN0dWFsIGxlZ2FsIG1lYW5pbmcgY2FuIGJlIGZvdW5kIGF0IHRoZSBhYm92ZSBsaW5rLikKRG9uJ3QgYXNrIG1lIGZvciBwZXJtaXNzaW9uIHRvIHVzZSBhbnkgcGFydCBvZiB0aGlzIHByb2plY3QsIEpVU1QgVVNFIElULgpJIHdvdWxkIGFwcHJlY2lhdGUgYXR0cmlidXRpb24sIGJ1dCB0aGF0IGlzIG5vdCByZXF1aXJlZCBieSB0aGUgbGljZW5zZS4KKi8KCi8qClRoaXMgZmlsZSB1c2VzIGEgbW9kdWxlIHBhdHRlcm4gdG8gYXZvaWQgbGVha2luZyBuYW1lcyBpbnRvIHRoZSBnbG9iYWwgc2NvcGUuClRoZSBvbmx5IGFjY2lkZW50YWwgbGVha2FnZSBpcyB0aGUgbmFtZSAidGVtcCIuClRoZSBleHBvcnRlZCBuYW1lcyBjYW4gYmUgZm91bmQgYXQgdGhlIGJvdHRvbSBvZiB0aGlzIGZpbGU7CnNpbXBseSBjaGFuZ2UgdGhlIG5hbWVzIGluIHRoZSBhcnJheSBvZiBzdHJpbmdzIHRvIGNoYW5nZSB3aGF0IHRoZXkgYXJlIGNhbGxlZCBpbiB5b3VyIGFwcGxpY2F0aW9uLgoKQXMgd2VsbCwgc2V2ZXJhbCBjb25maWd1cmF0aW9uIGNvbnN0YW50cyBhcmUgcGFzc2VkIGludG8gdGhlIG1vZHVsZSBmdW5jdGlvbiBhdCB0aGUgYm90dG9tIG9mIHRoaXMgZmlsZS4KQXQgcnVudGltZSwgdGhlc2UgY29uc3RhbnRzIGNhbiBiZSBmb3VuZCBvbiB0aGUgRGlhZ3JhbSBjbGFzcy4KKi8KCihmdW5jdGlvbihvcHRpb25zKSB7CglmdW5jdGlvbiBzdWJjbGFzc09mKGJhc2VDbGFzcywgc3VwZXJDbGFzcykgewoJCWJhc2VDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ2xhc3MucHJvdG90eXBlKTsKCQliYXNlQ2xhc3MucHJvdG90eXBlLiRzdXBlciA9IHN1cGVyQ2xhc3MucHJvdG90eXBlOwoJfQoKCWZ1bmN0aW9uIHVubnVsbCgvKiBjaGlsZHJlbiAqLykgewoJCXJldHVybiBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cykucmVkdWNlKGZ1bmN0aW9uKHNvZmFyLCB4KSB7IHJldHVybiBzb2ZhciAhPT0gdW5kZWZpbmVkID8gc29mYXIgOiB4OyB9KTsKCX0KCglmdW5jdGlvbiBkZXRlcm1pbmVHYXBzKG91dGVyLCBpbm5lcikgewoJCXZhciBkaWZmID0gb3V0ZXIgLSBpbm5lcjsKCQlzd2l0Y2goRGlhZ3JhbS5JTlRFUk5BTF9BTElHTk1FTlQpIHsKCQkJY2FzZSAnbGVmdCc6IHJldHVybiBbMCwgZGlmZl07IGJyZWFrOwoJCQljYXNlICdyaWdodCc6IHJldHVybiBbZGlmZiwgMF07IGJyZWFrOwoJCQljYXNlICdjZW50ZXInOgoJCQlkZWZhdWx0OiByZXR1cm4gW2RpZmYvMiwgZGlmZi8yXTsgYnJlYWs7CgkJfQoJfQoKCWZ1bmN0aW9uIHdyYXBTdHJpbmcodmFsdWUpIHsKCQlyZXR1cm4gKCh0eXBlb2YgdmFsdWUpID09ICdzdHJpbmcnKSA/IG5ldyBUZXJtaW5hbCh2YWx1ZSkgOiB2YWx1ZTsKCX0KCglmdW5jdGlvbiBzdGFja0F0SWxsZWdhbFBvc2l0aW9uKGl0ZW1zKXsKCQkvKiBUaGUgaGVpZ2h0IG9mIHRoZSBsYXN0IGxpbmUgb2YgdGhlIFN0YWNrIGlzIGRldGVybWluZWQgYnkgdGhlIGxhc3QgY2hpbGQgYW5kIAoJCQl0aGVyZWZvcmUgYW55IGVsZW1lbnQgb3V0c2lkZSB0aGUgU3RhY2sgY291bGQgb3ZlcmxhcCB3aXRoIG90aGVyIGVsZW1lbnRzLgoJCQlJZiB0aGUgU3RhY2sgaXMgdGhlIGxhc3QgZWxlbWVudCBubyBvdmVybGFwIGNhbiBvY2N1ci4gKi8KCQlmb3IodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHsKCQkJaWYoaXRlbXNbaV0gaW5zdGFuY2VvZiBTdGFjayAmJiBpICE9PSBpdGVtcy5sZW5ndGgtMSl7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9CgoJZnVuY3Rpb24gU1ZHKG5hbWUsIGF0dHJzLCB0ZXh0KSB7CgkJYXR0cnMgPSBhdHRycyB8fCB7fTsKCQl0ZXh0ID0gdGV4dCB8fCAnJzsKCQl2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIixuYW1lKTsKCQlmb3IodmFyIGF0dHIgaW4gYXR0cnMpIHsKCQkJaWYoYXR0ciA9PT0gJ3hsaW5rOmhyZWYnKQoJCQkJZWwuc2V0QXR0cmlidXRlTlMoImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiLCAnaHJlZicsIGF0dHJzW2F0dHJdKTsKCQkJZWxzZQoJCQkJZWwuc2V0QXR0cmlidXRlKGF0dHIsIGF0dHJzW2F0dHJdKTsKCQl9CgkJZWwudGV4dENvbnRlbnQgPSB0ZXh0OwoJCXJldHVybiBlbDsKCX0KCglmdW5jdGlvbiBGYWtlU1ZHKHRhZ05hbWUsIGF0dHJzLCB0ZXh0KXsKCQlpZighKHRoaXMgaW5zdGFuY2VvZiBGYWtlU1ZHKSkgcmV0dXJuIG5ldyBGYWtlU1ZHKHRhZ05hbWUsIGF0dHJzLCB0ZXh0KTsKCQlpZih0ZXh0KSB0aGlzLmNoaWxkcmVuID0gdGV4dDsKCQllbHNlIHRoaXMuY2hpbGRyZW4gPSBbXTsKCQl0aGlzLnRhZ05hbWUgPSB0YWdOYW1lOwoJCXRoaXMuYXR0cnMgPSB1bm51bGwoYXR0cnMsIHt9KTsKCQlyZXR1cm4gdGhpczsKCX07CglGYWtlU1ZHLnByb3RvdHlwZS5mb3JtYXQgPSBmdW5jdGlvbih4LCB5LCB3aWR0aCkgewoJCS8vIFZpcnR1YWwKCX07CglGYWtlU1ZHLnByb3RvdHlwZS5hZGRUbyA9IGZ1bmN0aW9uKHBhcmVudCkgewoJCWlmKHBhcmVudCBpbnN0YW5jZW9mIEZha2VTVkcpIHsKCQkJcGFyZW50LmNoaWxkcmVuLnB1c2godGhpcyk7CgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXZhciBzdmcgPSB0aGlzLnRvU1ZHKCk7CgkJCXBhcmVudC5hcHBlbmRDaGlsZChzdmcpOwoJCQlyZXR1cm4gc3ZnOwoJCX0KCX07CglGYWtlU1ZHLnByb3RvdHlwZS5lc2NhcGVTdHJpbmcgPSBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgICAgICAgICAgIC8vIEVzY2FwZSBtYXJrZG93biBhbmQgSFRNTCBzcGVjaWFsIGNoYXJhY3RlcnMKCQlyZXR1cm4gc3RyaW5nLnJlcGxhY2UoL1sqX1xgXFtcXTwmXS9nLCBmdW5jdGlvbihjaGFyU3RyaW5nKSB7CgkJCXJldHVybiAnJiMnICsgY2hhclN0cmluZy5jaGFyQ29kZUF0KDApICsgJzsnOwoJCX0pOwoJfTsKCUZha2VTVkcucHJvdG90eXBlLnRvU1ZHID0gZnVuY3Rpb24oKSB7CgkJdmFyIGVsID0gU1ZHKHRoaXMudGFnTmFtZSwgdGhpcy5hdHRycyk7CgkJaWYodHlwZW9mIHRoaXMuY2hpbGRyZW4gPT0gJ3N0cmluZycpIHsKCQkJZWwudGV4dENvbnRlbnQgPSB0aGlzLmNoaWxkcmVuOwoJCX0gZWxzZSB7CgkJCXRoaXMuY2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbihlKSB7CgkJCQllbC5hcHBlbmRDaGlsZChlLnRvU1ZHKCkpOwoJCQl9KTsKCQl9CgkJcmV0dXJuIGVsOwoJfTsKCUZha2VTVkcucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CgkJdmFyIHN0ciA9ICc8JyArIHRoaXMudGFnTmFtZTsKCQl2YXIgZ3JvdXAgPSB0aGlzLnRhZ05hbWUgPT0gImciIHx8IHRoaXMudGFnTmFtZSA9PSAic3ZnIjsKCQlmb3IodmFyIGF0dHIgaW4gdGhpcy5hdHRycykgewoJCQlzdHIgKz0gJyAnICsgYXR0ciArICc9IicgKyAodGhpcy5hdHRyc1thdHRyXSsnJykucmVwbGFjZSgvJi9nLCAnJmFtcDsnKS5yZXBsYWNlKC8iL2csICcmcXVvdDsnKSArICciJzsKCQl9CgkJc3RyICs9ICc+JzsKCQlpZihncm91cCkgc3RyICs9ICJcbiI7CgkJaWYodHlwZW9mIHRoaXMuY2hpbGRyZW4gPT0gJ3N0cmluZycpIHsKCQkJc3RyICs9IEZha2VTVkcucHJvdG90eXBlLmVzY2FwZVN0cmluZyh0aGlzLmNoaWxkcmVuKTsKCQl9IGVsc2UgewoJCQl0aGlzLmNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24oZSkgewoJCQkJc3RyICs9IGU7CgkJCX0pOwoJCX0KCQlzdHIgKz0gJzwvJyArIHRoaXMudGFnTmFtZSArICc+XG4nOwoJCXJldHVybiBzdHI7Cgl9CgoJZnVuY3Rpb24gUGF0aCh4LHkpIHsKCQlpZighKHRoaXMgaW5zdGFuY2VvZiBQYXRoKSkgcmV0dXJuIG5ldyBQYXRoKHgseSk7CgkJRmFrZVNWRy5jYWxsKHRoaXMsICdwYXRoJyk7CgkJdGhpcy5hdHRycy5kID0gIk0iK3grJyAnK3k7Cgl9CglzdWJjbGFzc09mKFBhdGgsIEZha2VTVkcpOwoJUGF0aC5wcm90b3R5cGUubSA9IGZ1bmN0aW9uKHgseSkgewoJCXRoaXMuYXR0cnMuZCArPSAnbScreCsnICcreTsKCQlyZXR1cm4gdGhpczsKCX0KCVBhdGgucHJvdG90eXBlLmggPSBmdW5jdGlvbih2YWwpIHsKCQl0aGlzLmF0dHJzLmQgKz0gJ2gnK3ZhbDsKCQlyZXR1cm4gdGhpczsKCX0KCVBhdGgucHJvdG90eXBlLnJpZ2h0ID0gUGF0aC5wcm90b3R5cGUuaDsKCVBhdGgucHJvdG90eXBlLmxlZnQgPSBmdW5jdGlvbih2YWwpIHsgcmV0dXJuIHRoaXMuaCgtdmFsKTsgfQoJUGF0aC5wcm90b3R5cGUudiA9IGZ1bmN0aW9uKHZhbCkgewoJCXRoaXMuYXR0cnMuZCArPSAndicrdmFsOwoJCXJldHVybiB0aGlzOwoJfQoJUGF0aC5wcm90b3R5cGUuZG93biA9IFBhdGgucHJvdG90eXBlLnY7CglQYXRoLnByb3RvdHlwZS51cCA9IGZ1bmN0aW9uKHZhbCkgeyByZXR1cm4gdGhpcy52KC12YWwpOyB9CglQYXRoLnByb3RvdHlwZS5hcmMgPSBmdW5jdGlvbihzd2VlcCl7CgkJdmFyIHggPSBEaWFncmFtLkFSQ19SQURJVVM7CgkJdmFyIHkgPSBEaWFncmFtLkFSQ19SQURJVVM7CgkJaWYoc3dlZXBbMF0gPT0gJ2UnIHx8IHN3ZWVwWzFdID09ICd3JykgewoJCQl4ICo9IC0xOwoJCX0KCQlpZihzd2VlcFswXSA9PSAncycgfHwgc3dlZXBbMV0gPT0gJ24nKSB7CgkJCXkgKj0gLTE7CgkJfQoJCWlmKHN3ZWVwID09ICduZScgfHwgc3dlZXAgPT0gJ2VzJyB8fCBzd2VlcCA9PSAnc3cnIHx8IHN3ZWVwID09ICd3bicpIHsKCQkJdmFyIGN3ID0gMTsKCQl9IGVsc2UgewoJCQl2YXIgY3cgPSAwOwoJCX0KCQl0aGlzLmF0dHJzLmQgKz0gImEiK0RpYWdyYW0uQVJDX1JBRElVUysiICIrRGlhZ3JhbS5BUkNfUkFESVVTKyIgMCAwICIrY3crJyAnK3grJyAnK3k7CgkJcmV0dXJuIHRoaXM7Cgl9CglQYXRoLnByb3RvdHlwZS5mb3JtYXQgPSBmdW5jdGlvbigpIHsKCQkvLyBBbGwgcGF0aHMgaW4gdGhpcyBsaWJyYXJ5IHN0YXJ0L2VuZCBob3Jpem9udGFsbHkuCgkJLy8gVGhlIGV4dHJhIC41IGVuc3VyZXMgYSBtaW5vciBvdmVybGFwLCBzbyB0aGVyZSdzIG5vIHNlYW1zIGluIGJhZCByYXN0ZXJpemVycy4KCQl0aGlzLmF0dHJzLmQgKz0gJ2guNSc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJZnVuY3Rpb24gRGlhZ3JhbShpdGVtcykgewoJCWlmKCEodGhpcyBpbnN0YW5jZW9mIERpYWdyYW0pKSByZXR1cm4gbmV3IERpYWdyYW0oW10uc2xpY2UuY2FsbChhcmd1bWVudHMpKTsKCQlGYWtlU1ZHLmNhbGwodGhpcywgJ3N2ZycsIHtjbGFzczogRGlhZ3JhbS5ESUFHUkFNX0NMQVNTfSk7CgkJaWYoc3RhY2tBdElsbGVnYWxQb3NpdGlvbihpdGVtcykpewoJCQl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiU3RhY2soKSBtdXN0IG9ubHkgb2NjdXIgYXQgdGhlIHZlcnkgbGFzdCBwb3NpdGlvbiBvZiBEaWFncmFtKCkuIik7CgkJfQoJCXRoaXMuaXRlbXMgPSBpdGVtcy5tYXAod3JhcFN0cmluZyk7CgkJdGhpcy5pdGVtcy51bnNoaWZ0KG5ldyBTdGFydCk7CgkJdGhpcy5pdGVtcy5wdXNoKG5ldyBFbmQpOwoJCXRoaXMud2lkdGggPSB0aGlzLml0ZW1zLnJlZHVjZShmdW5jdGlvbihzb2ZhciwgZWwpIHsgcmV0dXJuIHNvZmFyICsgZWwud2lkdGggKyAoZWwubmVlZHNTcGFjZT8yMDowKX0sIDApKzE7CgkJdGhpcy5oZWlnaHQgPSB0aGlzLml0ZW1zLnJlZHVjZShmdW5jdGlvbihzb2ZhciwgZWwpIHsgcmV0dXJuIHNvZmFyICsgZWwuaGVpZ2h0IH0sIDApOwoJCXRoaXMudXAgPSBNYXRoLm1heC5hcHBseShudWxsLCB0aGlzLml0ZW1zLm1hcChmdW5jdGlvbiAoeCkgeyByZXR1cm4geC51cDsgfSkpOwoJCXRoaXMuZG93biA9IE1hdGgubWF4LmFwcGx5KG51bGwsIHRoaXMuaXRlbXMubWFwKGZ1bmN0aW9uICh4KSB7IHJldHVybiB4LmRvd247IH0pKTsKCQl0aGlzLmZvcm1hdHRlZCA9IGZhbHNlOwoJfQoJc3ViY2xhc3NPZihEaWFncmFtLCBGYWtlU1ZHKTsKCWZvcih2YXIgb3B0aW9uIGluIG9wdGlvbnMpIHsKCQlEaWFncmFtW29wdGlvbl0gPSBvcHRpb25zW29wdGlvbl07Cgl9CglEaWFncmFtLnByb3RvdHlwZS5mb3JtYXQgPSBmdW5jdGlvbihwYWRkaW5ndCwgcGFkZGluZ3IsIHBhZGRpbmdiLCBwYWRkaW5nbCkgewoJCXBhZGRpbmd0ID0gdW5udWxsKHBhZGRpbmd0LCAyMCk7CgkJcGFkZGluZ3IgPSB1bm51bGwocGFkZGluZ3IsIHBhZGRpbmd0LCAyMCk7CgkJcGFkZGluZ2IgPSB1bm51bGwocGFkZGluZ2IsIHBhZGRpbmd0LCAyMCk7CgkJcGFkZGluZ2wgPSB1bm51bGwocGFkZGluZ2wsIHBhZGRpbmdyLCAyMCk7CgkJdmFyIHggPSBwYWRkaW5nbDsKCQl2YXIgeSA9IHBhZGRpbmd0OwoJCXkgKz0gdGhpcy51cDsKCQl2YXIgZyA9IEZha2VTVkcoJ2cnLCBEaWFncmFtLlNUUk9LRV9PRERfUElYRUxfTEVOR1RIID8ge3RyYW5zZm9ybTondHJhbnNsYXRlKC41IC41KSd9IDoge30pOwoJCWZvcih2YXIgaSA9IDA7IGkgPCB0aGlzLml0ZW1zLmxlbmd0aDsgaSsrKSB7CgkJCXZhciBpdGVtID0gdGhpcy5pdGVtc1tpXTsKCQkJaWYoaXRlbS5uZWVkc1NwYWNlKSB7CgkJCQlQYXRoKHgseSkuaCgxMCkuYWRkVG8oZyk7CgkJCQl4ICs9IDEwOwoJCQl9CgkJCWl0ZW0uZm9ybWF0KHgsIHksIGl0ZW0ud2lkdGgraXRlbS5vZmZzZXRYKS5hZGRUbyhnKTsKCQkJeCArPSBpdGVtLndpZHRoICsgaXRlbS5vZmZzZXRYOwoJCQl5ICs9IGl0ZW0uaGVpZ2h0OwoJCQlpZihpdGVtLm5lZWRzU3BhY2UpIHsKCQkJCVBhdGgoeCx5KS5oKDEwKS5hZGRUbyhnKTsKCQkJCXggKz0gMTA7CgkJCX0KCQl9CgkJdGhpcy5hdHRycy53aWR0aCA9IHRoaXMud2lkdGggKyBwYWRkaW5nbCArIHBhZGRpbmdyOwoJCXRoaXMuYXR0cnMuaGVpZ2h0ID0gdGhpcy51cCArIHRoaXMuaGVpZ2h0ICsgdGhpcy5kb3duICsgcGFkZGluZ3QgKyBwYWRkaW5nYjsKCQl0aGlzLmF0dHJzLnZpZXdCb3ggPSAiMCAwICIgICsgdGhpcy5hdHRycy53aWR0aCArICIgIiArIHRoaXMuYXR0cnMuaGVpZ2h0OwoJCWcuYWRkVG8odGhpcyk7CgkJdGhpcy5mb3JtYXR0ZWQgPSB0cnVlOwoJCXJldHVybiB0aGlzOwoJfQoJRGlhZ3JhbS5wcm90b3R5cGUuYWRkVG8gPSBmdW5jdGlvbihwYXJlbnQpIHsKCQl2YXIgc2NyaXB0VGFnID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3NjcmlwdCcpOwoJCXNjcmlwdFRhZyA9IHNjcmlwdFRhZ1tzY3JpcHRUYWcubGVuZ3RoIC0gMV07CgkJdmFyIHBhcmVudFRhZyA9IHNjcmlwdFRhZy5wYXJlbnROb2RlOwoJCXBhcmVudCA9IHBhcmVudCB8fCBwYXJlbnRUYWc7CgkJcmV0dXJuIHRoaXMuJHN1cGVyLmFkZFRvLmNhbGwodGhpcywgcGFyZW50KTsKCX0KCURpYWdyYW0ucHJvdG90eXBlLnRvU1ZHID0gZnVuY3Rpb24oKSB7CgkJaWYgKCF0aGlzLmZvcm1hdHRlZCkgewoJCQl0aGlzLmZvcm1hdCgpOwoJCX0KCQlyZXR1cm4gdGhpcy4kc3VwZXIudG9TVkcuY2FsbCh0aGlzKTsKCX0KCURpYWdyYW0ucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CgkJaWYgKCF0aGlzLmZvcm1hdHRlZCkgewoJCQl0aGlzLmZvcm1hdCgpOwoJCX0KCQlyZXR1cm4gdGhpcy4kc3VwZXIudG9TdHJpbmcuY2FsbCh0aGlzKTsKCX0KCglmdW5jdGlvbiBDb21wbGV4RGlhZ3JhbSgpIHsKCQl2YXIgZGlhZ3JhbSA9IG5ldyBEaWFncmFtKFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzKSk7CiAgICAgICAgICAgICAgICB2YXIgaXRlbXMgPSBkaWFncmFtLml0ZW1zOwoJCWl0ZW1zLnNoaWZ0KCk7CgkJaXRlbXMucG9wKCk7CgkJaXRlbXMudW5zaGlmdChuZXcgU3RhcnQoZmFsc2UpKTsKCQlpdGVtcy5wdXNoKG5ldyBFbmQoZmFsc2UpKTsKCQlkaWFncmFtLml0ZW1zID0gaXRlbXM7CgkJcmV0dXJuIGRpYWdyYW07CiAgICAgICAgfQoKCWZ1bmN0aW9uIFNlcXVlbmNlKGl0ZW1zKSB7CgkJaWYoISh0aGlzIGluc3RhbmNlb2YgU2VxdWVuY2UpKSByZXR1cm4gbmV3IFNlcXVlbmNlKFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzKSk7CgkJRmFrZVNWRy5jYWxsKHRoaXMsICdnJyk7CgkJaWYoc3RhY2tBdElsbGVnYWxQb3NpdGlvbihpdGVtcykpewoJCQl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiU3RhY2soKSBtdXN0IG9ubHkgb2NjdXIgYXQgdGhlIHZlcnkgbGFzdCBwb3NpdGlvbiBvZiBTZXF1ZW5jZSgpLiIpOwoJCX0KCQl0aGlzLml0ZW1zID0gaXRlbXMubWFwKHdyYXBTdHJpbmcpOwoJCXRoaXMud2lkdGggPSB0aGlzLml0ZW1zLnJlZHVjZShmdW5jdGlvbihzb2ZhciwgZWwpIHsgcmV0dXJuIHNvZmFyICsgZWwud2lkdGggKyAoZWwubmVlZHNTcGFjZT8yMDowKX0sIDApOwoJCXRoaXMub2Zmc2V0WCA9IDA7CgkJdGhpcy5oZWlnaHQgPSB0aGlzLml0ZW1zLnJlZHVjZShmdW5jdGlvbihzb2ZhciwgZWwpIHsgcmV0dXJuIHNvZmFyICsgZWwuaGVpZ2h0IH0sIDApOwoJCXRoaXMudXAgPSB0aGlzLml0ZW1zLnJlZHVjZShmdW5jdGlvbihzb2ZhcixlbCkgeyByZXR1cm4gTWF0aC5tYXgoc29mYXIsIGVsLnVwKX0sIDApOwoJCXRoaXMuZG93biA9IHRoaXMuaXRlbXMucmVkdWNlKGZ1bmN0aW9uKHNvZmFyLGVsKSB7IHJldHVybiBNYXRoLm1heChzb2ZhciwgZWwuZG93bil9LCAwKTsKCX0KCXN1YmNsYXNzT2YoU2VxdWVuY2UsIEZha2VTVkcpOwoJU2VxdWVuY2UucHJvdG90eXBlLmZvcm1hdCA9IGZ1bmN0aW9uKHgseSx3aWR0aCkgewoJCS8vIEhvb2sgdXAgdGhlIHR3byBzaWRlcyBpZiB0aGlzIGlzIG5hcnJvd2VyIHRoYW4gaXRzIHN0YXRlZCB3aWR0aC4KCQl2YXIgZ2FwcyA9IGRldGVybWluZUdhcHMod2lkdGgsIHRoaXMud2lkdGgpOwoJCVBhdGgoeCx5KS5oKGdhcHNbMF0pLmFkZFRvKHRoaXMpOwoJCVBhdGgoeCtnYXBzWzBdK3RoaXMud2lkdGgseSt0aGlzLmhlaWdodCkuaChnYXBzWzFdKS5hZGRUbyh0aGlzKTsKCQl4ICs9IGdhcHNbMF07CgoJCWZvcih2YXIgaSA9IDA7IGkgPCB0aGlzLml0ZW1zLmxlbmd0aDsgaSsrKSB7CgkJCXZhciBpdGVtID0gdGhpcy5pdGVtc1tpXTsKCQkJaWYoaXRlbS5uZWVkc1NwYWNlKSB7CgkJCQlQYXRoKHgseSkuaCgxMCkuYWRkVG8odGhpcyk7CgkJCQl4ICs9IDEwOwoJCQl9CgkJCWl0ZW0uZm9ybWF0KHgsIHksIGl0ZW0ud2lkdGgpLmFkZFRvKHRoaXMpOwoJCQl4ICs9IGl0ZW0ud2lkdGg7CgkJCXkgKz0gaXRlbS5oZWlnaHQ7CgkJCWlmKGl0ZW0ubmVlZHNTcGFjZSkgewoJCQkJUGF0aCh4LHkpLmgoMTApLmFkZFRvKHRoaXMpOwoJCQkJeCArPSAxMDsKCQkJfQoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCQoJZnVuY3Rpb24gU3RhY2soaXRlbXMpIHsKCQlpZighKHRoaXMgaW5zdGFuY2VvZiBTdGFjaykpIHJldHVybiBuZXcgU3RhY2soW10uc2xpY2UuY2FsbChhcmd1bWVudHMpKTsKCQlGYWtlU1ZHLmNhbGwodGhpcywgJ2cnKTsKCQlpZihzdGFja0F0SWxsZWdhbFBvc2l0aW9uKGl0ZW1zKSl7CgkJCXRocm93IG5ldyBSYW5nZUVycm9yKCJTdGFjaygpIG11c3Qgb25seSBvY2N1ciBhdCB0aGUgdmVyeSBsYXN0IHBvc2l0aW9uIG9mIFN0YWNrKCkuIik7CgkJfQoJCWlmKCBpdGVtcy5sZW5ndGggPT09IDAgKSB7CgkJCXRocm93IG5ldyBSYW5nZUVycm9yKCJTdGFjaygpIG11c3QgaGF2ZSBhdCBsZWFzdCBvbmUgY2hpbGQuIik7CgkJfQoJCXRoaXMuaXRlbXMgPSBpdGVtcy5tYXAod3JhcFN0cmluZyk7CgkJdGhpcy53aWR0aCA9IHRoaXMuaXRlbXMucmVkdWNlKGZ1bmN0aW9uKHNvZmFyLGVsKSB7IHJldHVybiBNYXRoLm1heChzb2ZhciwgZWwud2lkdGggKyAoZWwubmVlZHNTcGFjZT8yMDowKSl9LCAwKTsKCQlpZih0aGlzLml0ZW1zLmxlbmd0aCA+IDEpewoJCQl0aGlzLndpZHRoICs9IERpYWdyYW0uQVJDX1JBRElVUyoyOwoJCX0KCQkKCQl0aGlzLnVwID0gdGhpcy5pdGVtc1swXS51cDsKCQl0aGlzLmRvd24gPSB0aGlzLml0ZW1zW3RoaXMuaXRlbXMubGVuZ3RoLTFdLmRvd247CgkJCgkJdGhpcy5oZWlnaHQgPSAwOwoJCWZvcih2YXIgaSA9IDA7IGkgPCB0aGlzLml0ZW1zLmxlbmd0aDsgaSsrKSB7CgkJCXRoaXMuaGVpZ2h0ICs9IHRoaXMuaXRlbXNbaV0uaGVpZ2h0OwoJCQlpZihpICE9PSB0aGlzLml0ZW1zLmxlbmd0aC0xKSB7CgkJCQl0aGlzLmhlaWdodCArPSBNYXRoLm1heCh0aGlzLml0ZW1zW2ldLmRvd24sIERpYWdyYW0uVkVSVElDQUxfU0VQQVJBVElPTikgKyBNYXRoLm1heCh0aGlzLml0ZW1zW2krMV0udXAsIERpYWdyYW0uVkVSVElDQUxfU0VQQVJBVElPTikgKyBEaWFncmFtLkFSQ19SQURJVVMqNDsKCQkJfQoJCX0KCQkKCQlpZih0aGlzLml0ZW1zLmxlbmd0aCA9PT0gMCl7CgkJCXRoaXMub2Zmc2V0WCA9IDA7CgkJfQoJCWVsc2V7CgkJCS8vIHRoZSB2YWx1ZSBpcyB1c3VhbGx5IG5lZ2F0aXZlIGJlY2F1c2UgdGhlIGxpbmVicmVhayByZXNldHMgdGhlIHggdmFsdWUgZm9yIHRoZSBuZXh0IGVsZW1lbnQKCQkJdGhpcy5vZmZzZXRYID0gLSh0aGlzLndpZHRoIC0gdGhpcy5pdGVtc1t0aGlzLml0ZW1zLmxlbmd0aC0xXS53aWR0aCAtIHRoaXMuaXRlbXNbdGhpcy5pdGVtcy5sZW5ndGgtMV0ub2Zmc2V0WCAtICh0aGlzLml0ZW1zW3RoaXMuaXRlbXMubGVuZ3RoLTFdLm5lZWRzU3BhY2U/MjA6MCkpOwoJCQlpZih0aGlzLml0ZW1zLmxlbmd0aCA+IDEpewoJCQkJdGhpcy5vZmZzZXRYICs9IERpYWdyYW0uQVJDX1JBRElVUyoyOwoJCQl9CgkJfQoJfQoJc3ViY2xhc3NPZihTdGFjaywgRmFrZVNWRyk7CglTdGFjay5wcm90b3R5cGUuZm9ybWF0ID0gZnVuY3Rpb24oeCx5LHdpZHRoKSB7CgkJdmFyIHhJbnRpdGlhbCA9IHg7CgkJCgkJZm9yKHZhciBpID0gMDsgaSA8IHRoaXMuaXRlbXMubGVuZ3RoOyBpKyspIHsKCQkJdmFyIGl0ZW0gPSB0aGlzLml0ZW1zW2ldOwoJCQlpZihpdGVtLm5lZWRzU3BhY2UpIHsKCQkJCVBhdGgoeCx5KS5oKDEwKS5hZGRUbyh0aGlzKTsKCQkJCXggKz0gMTA7CgkJCX0KCQkJaXRlbS5mb3JtYXQoeCwgeSwgTWF0aC5tYXgoaXRlbS53aWR0aCtpdGVtLm9mZnNldFgsIERpYWdyYW0uQVJDX1JBRElVUyoyKSkuYWRkVG8odGhpcyk7CgkJCXggKz0gTWF0aC5tYXgoaXRlbS53aWR0aCtpdGVtLm9mZnNldFgsIERpYWdyYW0uQVJDX1JBRElVUyoyKTsKCQkJeSArPSBpdGVtLmhlaWdodDsKCQkJaWYoaXRlbS5uZWVkc1NwYWNlKSB7CgkJCQlQYXRoKHgseSkuaCgxMCkuYWRkVG8odGhpcyk7CgkJCQl4ICs9IDEwOwoJCQl9CgkJCQoJCQlpZihpICE9PSB0aGlzLml0ZW1zLmxlbmd0aC0xKSB7CgkJCQlQYXRoKHgsIHkpLmFyYygnbmUnKS5kb3duKE1hdGgubWF4KGl0ZW0uZG93biwgRGlhZ3JhbS5WRVJUSUNBTF9TRVBBUkFUSU9OKSkuYXJjKCdlcycpLmxlZnQoeC14SW50aXRpYWwtRGlhZ3JhbS5BUkNfUkFESVVTKjIpLmFyYygnbncnKS5kb3duKE1hdGgubWF4KHRoaXMuaXRlbXNbaSsxXS51cCwgRGlhZ3JhbS5WRVJUSUNBTF9TRVBBUkFUSU9OKSkuYXJjKCd3cycpLmFkZFRvKHRoaXMpOwoJCQkJCgkJCQl5ICs9IE1hdGgubWF4KGl0ZW0uZG93biwgRGlhZ3JhbS5WRVJUSUNBTF9TRVBBUkFUSU9OKSArIE1hdGgubWF4KHRoaXMuaXRlbXNbaSsxXS51cCwgRGlhZ3JhbS5WRVJUSUNBTF9TRVBBUkFUSU9OKSArIERpYWdyYW0uQVJDX1JBRElVUyo0OwoJCQkJeCA9IHhJbnRpdGlhbCtEaWFncmFtLkFSQ19SQURJVVMqMjsKCQkJfQoJCQkKCQl9CgkJCgkJUGF0aCh4LHkpLmgod2lkdGgtKHRoaXMud2lkdGgrdGhpcy5vZmZzZXRYKSkuYWRkVG8odGhpcyk7CgkJCgkJcmV0dXJuIHRoaXM7Cgl9CgoJZnVuY3Rpb24gQ2hvaWNlKG5vcm1hbCwgaXRlbXMpIHsKCQlpZighKHRoaXMgaW5zdGFuY2VvZiBDaG9pY2UpKSByZXR1cm4gbmV3IENob2ljZShub3JtYWwsIFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLDEpKTsKCQlGYWtlU1ZHLmNhbGwodGhpcywgJ2cnKTsKCQlpZiggdHlwZW9mIG5vcm1hbCAhPT0gIm51bWJlciIgfHwgbm9ybWFsICE9PSBNYXRoLmZsb29yKG5vcm1hbCkgKSB7CgkJCXRocm93IG5ldyBUeXBlRXJyb3IoIlRoZSBmaXJzdCBhcmd1bWVudCBvZiBDaG9pY2UoKSBtdXN0IGJlIGFuIGludGVnZXIuIik7CgkJfSBlbHNlIGlmKG5vcm1hbCA8IDAgfHwgbm9ybWFsID49IGl0ZW1zLmxlbmd0aCkgewoJCQl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiVGhlIGZpcnN0IGFyZ3VtZW50IG9mIENob2ljZSgpIG11c3QgYmUgYW4gaW5kZXggZm9yIG9uZSBvZiB0aGUgaXRlbXMuIik7CgkJfSBlbHNlIHsKCQkJdGhpcy5ub3JtYWwgPSBub3JtYWw7CgkJfQoJCXRoaXMuaXRlbXMgPSBpdGVtcy5tYXAod3JhcFN0cmluZyk7CgkJdGhpcy53aWR0aCA9IHRoaXMuaXRlbXMucmVkdWNlKGZ1bmN0aW9uKHNvZmFyLCBlbCl7cmV0dXJuIE1hdGgubWF4KHNvZmFyLCBlbC53aWR0aCl9LDApICsgRGlhZ3JhbS5BUkNfUkFESVVTKjQ7CgkJdGhpcy5vZmZzZXRYID0gMDsKCQl0aGlzLmhlaWdodCA9IHRoaXMuaXRlbXNbbm9ybWFsXS5oZWlnaHQ7CgkJdGhpcy51cCA9IHRoaXMuZG93biA9IDA7CgkJZm9yKHZhciBpID0gMDsgaSA8IHRoaXMuaXRlbXMubGVuZ3RoOyBpKyspIHsKCQkJdmFyIGl0ZW0gPSB0aGlzLml0ZW1zW2ldOwoJCQlpZihpIDwgbm9ybWFsKSB7IHRoaXMudXAgKz0gTWF0aC5tYXgoRGlhZ3JhbS5BUkNfUkFESVVTLGl0ZW0udXAgKyBpdGVtLmhlaWdodCArIGl0ZW0uZG93biArIERpYWdyYW0uVkVSVElDQUxfU0VQQVJBVElPTik7IH0KCQkJaWYoaSA9PSBub3JtYWwpIHsgdGhpcy51cCArPSBNYXRoLm1heChEaWFncmFtLkFSQ19SQURJVVMsIGl0ZW0udXApOyB0aGlzLmRvd24gKz0gTWF0aC5tYXgoRGlhZ3JhbS5BUkNfUkFESVVTLCBpdGVtLmRvd24pOyB9CgkJCWlmKGkgPiBub3JtYWwpIHsgdGhpcy5kb3duICs9IE1hdGgubWF4KERpYWdyYW0uQVJDX1JBRElVUyxEaWFncmFtLlZFUlRJQ0FMX1NFUEFSQVRJT04gKyBpdGVtLnVwICsgaXRlbS5kb3duICsgaXRlbS5oZWlnaHQpOyB9CgkJfQoJfQoJc3ViY2xhc3NPZihDaG9pY2UsIEZha2VTVkcpOwoJQ2hvaWNlLnByb3RvdHlwZS5mb3JtYXQgPSBmdW5jdGlvbih4LHksd2lkdGgpIHsKCQkvLyBIb29rIHVwIHRoZSB0d28gc2lkZXMgaWYgdGhpcyBpcyBuYXJyb3dlciB0aGFuIGl0cyBzdGF0ZWQgd2lkdGguCgkJdmFyIGdhcHMgPSBkZXRlcm1pbmVHYXBzKHdpZHRoLCB0aGlzLndpZHRoKTsKCQlQYXRoKHgseSkuaChnYXBzWzBdKS5hZGRUbyh0aGlzKTsKCQlQYXRoKHgrZ2Fwc1swXSt0aGlzLndpZHRoLHkrdGhpcy5oZWlnaHQpLmgoZ2Fwc1sxXSkuYWRkVG8odGhpcyk7CgkJeCArPSBnYXBzWzBdOwoKCQl2YXIgbGFzdCA9IHRoaXMuaXRlbXMubGVuZ3RoIC0xOwoJCXZhciBpbm5lcldpZHRoID0gdGhpcy53aWR0aCAtIERpYWdyYW0uQVJDX1JBRElVUyo0OwoKCQkvLyBEbyB0aGUgZWxlbWVudHMgdGhhdCBjdXJ2ZSBhYm92ZQoJCWZvcih2YXIgaSA9IHRoaXMubm9ybWFsIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJdmFyIGl0ZW0gPSB0aGlzLml0ZW1zW2ldOwoJCQlpZiggaSA9PSB0aGlzLm5vcm1hbCAtIDEgKSB7CgkJCQl2YXIgZGlzdGFuY2VGcm9tWSA9IE1hdGgubWF4KERpYWdyYW0uQVJDX1JBRElVUyoyLCB0aGlzLml0ZW1zW2krMV0udXAgKyBEaWFncmFtLlZFUlRJQ0FMX1NFUEFSQVRJT04gKyBpdGVtLmhlaWdodCArIGl0ZW0uZG93bik7CgkJCX0KCQkJUGF0aCh4LHkpLmFyYygnc2UnKS51cChkaXN0YW5jZUZyb21ZIC0gRGlhZ3JhbS5BUkNfUkFESVVTKjIpLmFyYygnd24nKS5hZGRUbyh0aGlzKTsKCQkJaXRlbS5mb3JtYXQoeCtEaWFncmFtLkFSQ19SQURJVVMqMix5IC0gZGlzdGFuY2VGcm9tWSxpbm5lcldpZHRoKS5hZGRUbyh0aGlzKTsKCQkJUGF0aCh4K0RpYWdyYW0uQVJDX1JBRElVUyoyK2lubmVyV2lkdGgsIHktZGlzdGFuY2VGcm9tWStpdGVtLmhlaWdodCkuYXJjKCduZScpLmRvd24oZGlzdGFuY2VGcm9tWSAtIGl0ZW0uaGVpZ2h0ICsgdGhpcy5pdGVtc1t0aGlzLm5vcm1hbF0uaGVpZ2h0IC0gRGlhZ3JhbS5BUkNfUkFESVVTKjIpLmFyYygnd3MnKS5hZGRUbyh0aGlzKTsKCQkJZGlzdGFuY2VGcm9tWSArPSBNYXRoLm1heChEaWFncmFtLkFSQ19SQURJVVMsIGl0ZW0udXAgKyBEaWFncmFtLlZFUlRJQ0FMX1NFUEFSQVRJT04gKyAoaSA9PSAwID8gMCA6IHRoaXMuaXRlbXNbaS0xXS5kb3duK3RoaXMuaXRlbXNbaS0xXS5oZWlnaHQpKTsKCQl9CgoJCS8vIERvIHRoZSBzdHJhaWdodC1saW5lIHBhdGguCgkJUGF0aCh4LHkpLnJpZ2h0KERpYWdyYW0uQVJDX1JBRElVUyoyKS5hZGRUbyh0aGlzKTsKCQl0aGlzLml0ZW1zW3RoaXMubm9ybWFsXS5mb3JtYXQoeCtEaWFncmFtLkFSQ19SQURJVVMqMiwgeSwgaW5uZXJXaWR0aCkuYWRkVG8odGhpcyk7CgkJUGF0aCh4K0RpYWdyYW0uQVJDX1JBRElVUyoyK2lubmVyV2lkdGgsIHkrdGhpcy5oZWlnaHQpLnJpZ2h0KERpYWdyYW0uQVJDX1JBRElVUyoyKS5hZGRUbyh0aGlzKTsKCgkJLy8gRG8gdGhlIGVsZW1lbnRzIHRoYXQgY3VydmUgYmVsb3cKCQlmb3IodmFyIGkgPSB0aGlzLm5vcm1hbCsxOyBpIDw9IGxhc3Q7IGkrKykgewoJCQl2YXIgaXRlbSA9IHRoaXMuaXRlbXNbaV07CgkJCWlmKCBpID09IHRoaXMubm9ybWFsICsgMSApIHsKCQkJCXZhciBkaXN0YW5jZUZyb21ZID0gTWF0aC5tYXgoRGlhZ3JhbS5BUkNfUkFESVVTKjIsIHRoaXMuaXRlbXNbaS0xXS5oZWlnaHQgKyB0aGlzLml0ZW1zW2ktMV0uZG93biArIERpYWdyYW0uVkVSVElDQUxfU0VQQVJBVElPTiArIGl0ZW0udXApOwoJCQl9CgkJCVBhdGgoeCx5KS5hcmMoJ25lJykuZG93bihkaXN0YW5jZUZyb21ZIC0gRGlhZ3JhbS5BUkNfUkFESVVTKjIpLmFyYygnd3MnKS5hZGRUbyh0aGlzKTsKCQkJaXRlbS5mb3JtYXQoeCtEaWFncmFtLkFSQ19SQURJVVMqMiwgeStkaXN0YW5jZUZyb21ZLCBpbm5lcldpZHRoKS5hZGRUbyh0aGlzKTsKCQkJUGF0aCh4K0RpYWdyYW0uQVJDX1JBRElVUyoyK2lubmVyV2lkdGgsIHkrZGlzdGFuY2VGcm9tWStpdGVtLmhlaWdodCkuYXJjKCdzZScpLnVwKGRpc3RhbmNlRnJvbVkgLSBEaWFncmFtLkFSQ19SQURJVVMqMiArIGl0ZW0uaGVpZ2h0IC0gdGhpcy5pdGVtc1t0aGlzLm5vcm1hbF0uaGVpZ2h0KS5hcmMoJ3duJykuYWRkVG8odGhpcyk7CgkJCWRpc3RhbmNlRnJvbVkgKz0gTWF0aC5tYXgoRGlhZ3JhbS5BUkNfUkFESVVTLCBpdGVtLmhlaWdodCArIGl0ZW0uZG93biArIERpYWdyYW0uVkVSVElDQUxfU0VQQVJBVElPTiArIChpID09IGxhc3QgPyAwIDogdGhpcy5pdGVtc1tpKzFdLnVwKSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KCglmdW5jdGlvbiBPcHRpb25hbChpdGVtLCBza2lwKSB7CgkJaWYoIHNraXAgPT09IHVuZGVmaW5lZCApCgkJCXJldHVybiBDaG9pY2UoMSwgU2tpcCgpLCBpdGVtKTsKCQllbHNlIGlmICggc2tpcCA9PT0gInNraXAiICkKCQkJcmV0dXJuIENob2ljZSgwLCBTa2lwKCksIGl0ZW0pOwoJCWVsc2UKCQkJdGhyb3cgIlVua25vd24gdmFsdWUgZm9yIE9wdGlvbmFsKCkncyAnc2tpcCcgYXJndW1lbnQuIjsKCX0KCglmdW5jdGlvbiBPbmVPck1vcmUoaXRlbSwgcmVwKSB7CgkJaWYoISh0aGlzIGluc3RhbmNlb2YgT25lT3JNb3JlKSkgcmV0dXJuIG5ldyBPbmVPck1vcmUoaXRlbSwgcmVwKTsKCQlGYWtlU1ZHLmNhbGwodGhpcywgJ2cnKTsKCQlyZXAgPSByZXAgfHwgKG5ldyBTa2lwKTsKCQl0aGlzLml0ZW0gPSB3cmFwU3RyaW5nKGl0ZW0pOwoJCXRoaXMucmVwID0gd3JhcFN0cmluZyhyZXApOwoJCXRoaXMud2lkdGggPSBNYXRoLm1heCh0aGlzLml0ZW0ud2lkdGgsIHRoaXMucmVwLndpZHRoKSArIERpYWdyYW0uQVJDX1JBRElVUyoyOwoJCXRoaXMub2Zmc2V0WCA9IDA7CgkJdGhpcy5oZWlnaHQgPSB0aGlzLml0ZW0uaGVpZ2h0OwoJCXRoaXMudXAgPSB0aGlzLml0ZW0udXA7CgkJdGhpcy5kb3duID0gTWF0aC5tYXgoRGlhZ3JhbS5BUkNfUkFESVVTKjIsIHRoaXMuaXRlbS5kb3duICsgRGlhZ3JhbS5WRVJUSUNBTF9TRVBBUkFUSU9OICsgdGhpcy5yZXAudXAgKyB0aGlzLnJlcC5oZWlnaHQgKyB0aGlzLnJlcC5kb3duKTsKCX0KCXN1YmNsYXNzT2YoT25lT3JNb3JlLCBGYWtlU1ZHKTsKCU9uZU9yTW9yZS5wcm90b3R5cGUubmVlZHNTcGFjZSA9IHRydWU7CglPbmVPck1vcmUucHJvdG90eXBlLmZvcm1hdCA9IGZ1bmN0aW9uKHgseSx3aWR0aCkgewoJCS8vIEhvb2sgdXAgdGhlIHR3byBzaWRlcyBpZiB0aGlzIGlzIG5hcnJvd2VyIHRoYW4gaXRzIHN0YXRlZCB3aWR0aC4KCQl2YXIgZ2FwcyA9IGRldGVybWluZUdhcHMod2lkdGgsIHRoaXMud2lkdGgpOwoJCVBhdGgoeCx5KS5oKGdhcHNbMF0pLmFkZFRvKHRoaXMpOwoJCVBhdGgoeCtnYXBzWzBdK3RoaXMud2lkdGgseSt0aGlzLmhlaWdodCkuaChnYXBzWzFdKS5hZGRUbyh0aGlzKTsKCQl4ICs9IGdhcHNbMF07CgoJCS8vIERyYXcgaXRlbQoJCVBhdGgoeCx5KS5yaWdodChEaWFncmFtLkFSQ19SQURJVVMpLmFkZFRvKHRoaXMpOwoJCXRoaXMuaXRlbS5mb3JtYXQoeCtEaWFncmFtLkFSQ19SQURJVVMseSx0aGlzLndpZHRoLURpYWdyYW0uQVJDX1JBRElVUyoyKS5hZGRUbyh0aGlzKTsKCQlQYXRoKHgrdGhpcy53aWR0aC1EaWFncmFtLkFSQ19SQURJVVMseSt0aGlzLmhlaWdodCkucmlnaHQoRGlhZ3JhbS5BUkNfUkFESVVTKS5hZGRUbyh0aGlzKTsKCgkJLy8gRHJhdyByZXBlYXQgYXJjCgkJdmFyIGRpc3RhbmNlRnJvbVkgPSBNYXRoLm1heChEaWFncmFtLkFSQ19SQURJVVMqMiwgdGhpcy5pdGVtLmhlaWdodCt0aGlzLml0ZW0uZG93bitEaWFncmFtLlZFUlRJQ0FMX1NFUEFSQVRJT04rdGhpcy5yZXAudXApOwoJCVBhdGgoeCtEaWFncmFtLkFSQ19SQURJVVMseSkuYXJjKCdudycpLmRvd24oZGlzdGFuY2VGcm9tWS1EaWFncmFtLkFSQ19SQURJVVMqMikuYXJjKCd3cycpLmFkZFRvKHRoaXMpOwoJCXRoaXMucmVwLmZvcm1hdCh4K0RpYWdyYW0uQVJDX1JBRElVUywgeStkaXN0YW5jZUZyb21ZLCB0aGlzLndpZHRoIC0gRGlhZ3JhbS5BUkNfUkFESVVTKjIpLmFkZFRvKHRoaXMpOwoJCVBhdGgoeCt0aGlzLndpZHRoLURpYWdyYW0uQVJDX1JBRElVUywgeStkaXN0YW5jZUZyb21ZK3RoaXMucmVwLmhlaWdodCkuYXJjKCdzZScpLnVwKGRpc3RhbmNlRnJvbVktRGlhZ3JhbS5BUkNfUkFESVVTKjIrdGhpcy5yZXAuaGVpZ2h0LXRoaXMuaXRlbS5oZWlnaHQpLmFyYygnZW4nKS5hZGRUbyh0aGlzKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJZnVuY3Rpb24gWmVyb09yTW9yZShpdGVtLCByZXAsIHNraXApIHsKCQlyZXR1cm4gT3B0aW9uYWwoT25lT3JNb3JlKGl0ZW0sIHJlcCksIHNraXApOwoJfQoKCWZ1bmN0aW9uIFN0YXJ0KHNpbXBsZVR5cGUpIHsKCQlpZighKHRoaXMgaW5zdGFuY2VvZiBTdGFydCkpIHJldHVybiBuZXcgU3RhcnQoKTsKCQlGYWtlU1ZHLmNhbGwodGhpcywgJ3BhdGgnKTsKCQl0aGlzLndpZHRoID0gMjA7CgkJdGhpcy5oZWlnaHQgPSAwOwoJCXRoaXMub2Zmc2V0WCA9IDA7CgkJdGhpcy51cCA9IDEwOwoJCXRoaXMuZG93biA9IDEwOwoJCXRoaXMuc2ltcGxlVHlwZSA9IHNpbXBsZVR5cGU7Cgl9CglzdWJjbGFzc09mKFN0YXJ0LCBGYWtlU1ZHKTsKCVN0YXJ0LnByb3RvdHlwZS5mb3JtYXQgPSBmdW5jdGlvbih4LHkpIHsKCQlpZiAodGhpcy5zaW1wbGVUeXBlID09PSBmYWxzZSkgewoJCQl0aGlzLmF0dHJzLmQgPSAnTSAnK3grJyAnKyh5LTEwKSsnIHYgMjAgbSAwIC0xMCBoIDIwLjUnOwoJCX0gZWxzZSB7CgkJCXRoaXMuYXR0cnMuZCA9ICdNICcreCsnICcrKHktMTApKycgdiAyMCBtIDEwIC0yMCB2IDIwIG0gLTEwIC0xMCBoIDIwLjUnOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglmdW5jdGlvbiBFbmQoc2ltcGxlVHlwZSkgewoJCWlmKCEodGhpcyBpbnN0YW5jZW9mIEVuZCkpIHJldHVybiBuZXcgRW5kKCk7CgkJRmFrZVNWRy5jYWxsKHRoaXMsICdwYXRoJyk7CgkJdGhpcy53aWR0aCA9IDIwOwoJCXRoaXMuaGVpZ2h0ID0gMDsKCQl0aGlzLm9mZnNldFggPSAwOwoJCXRoaXMudXAgPSAxMDsKCQl0aGlzLmRvd24gPSAxMDsKCQl0aGlzLnNpbXBsZVR5cGUgPSBzaW1wbGVUeXBlOwoJfQoJc3ViY2xhc3NPZihFbmQsIEZha2VTVkcpOwoJRW5kLnByb3RvdHlwZS5mb3JtYXQgPSBmdW5jdGlvbih4LHkpIHsKCQlpZiAodGhpcy5zaW1wbGVUeXBlID09PSBmYWxzZSkgewoJCQl0aGlzLmF0dHJzLmQgPSAnTSAnK3grJyAnK3krJyBoIDIwIG0gMCAtMTAgdiAyMCc7CgkJfSBlbHNlIHsKCQkJdGhpcy5hdHRycy5kID0gJ00gJyt4KycgJyt5KycgaCAyMCBtIC0xMCAtMTAgdiAyMCBtIDEwIC0yMCB2IDIwJzsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJZnVuY3Rpb24gVGVybWluYWwodGV4dCwgaHJlZikgewoJCWlmKCEodGhpcyBpbnN0YW5jZW9mIFRlcm1pbmFsKSkgcmV0dXJuIG5ldyBUZXJtaW5hbCh0ZXh0LCBocmVmKTsKCQlGYWtlU1ZHLmNhbGwodGhpcywgJ2cnLCB7J2NsYXNzJzogJ3Rlcm1pbmFsJ30pOwoJCXRoaXMudGV4dCA9IHRleHQ7CgkJdGhpcy5ocmVmID0gaHJlZjsKCQl0aGlzLndpZHRoID0gdGV4dC5sZW5ndGggKiA4ICsgMjA7IC8qIEFzc3VtZSB0aGF0IGVhY2ggY2hhciBpcyAuNWVtLCBhbmQgdGhhdCB0aGUgZW0gaXMgMTZweCAqLwoJCXRoaXMuaGVpZ2h0ID0gMDsKCQl0aGlzLm9mZnNldFggPSAwOwoJCXRoaXMudXAgPSAxMTsKCQl0aGlzLmRvd24gPSAxMTsKCX0KCXN1YmNsYXNzT2YoVGVybWluYWwsIEZha2VTVkcpOwoJVGVybWluYWwucHJvdG90eXBlLm5lZWRzU3BhY2UgPSB0cnVlOwoJVGVybWluYWwucHJvdG90eXBlLmZvcm1hdCA9IGZ1bmN0aW9uKHgsIHksIHdpZHRoKSB7CgkJLy8gSG9vayB1cCB0aGUgdHdvIHNpZGVzIGlmIHRoaXMgaXMgbmFycm93ZXIgdGhhbiBpdHMgc3RhdGVkIHdpZHRoLgoJCXZhciBnYXBzID0gZGV0ZXJtaW5lR2Fwcyh3aWR0aCwgdGhpcy53aWR0aCk7CgkJUGF0aCh4LHkpLmgoZ2Fwc1swXSkuYWRkVG8odGhpcyk7CgkJUGF0aCh4K2dhcHNbMF0rdGhpcy53aWR0aCx5KS5oKGdhcHNbMV0pLmFkZFRvKHRoaXMpOwoJCXggKz0gZ2Fwc1swXTsKCgkJRmFrZVNWRygncmVjdCcsIHt4OngsIHk6eS0xMSwgd2lkdGg6dGhpcy53aWR0aCwgaGVpZ2h0OnRoaXMudXArdGhpcy5kb3duLCByeDoxMCwgcnk6MTB9KS5hZGRUbyh0aGlzKTsKCQl2YXIgdGV4dCA9IEZha2VTVkcoJ3RleHQnLCB7eDp4K3RoaXMud2lkdGgvMiwgeTp5KzR9LCB0aGlzLnRleHQpOwoJCWlmKHRoaXMuaHJlZikKCQkJRmFrZVNWRygnYScsIHsneGxpbms6aHJlZic6IHRoaXMuaHJlZn0sIFt0ZXh0XSkuYWRkVG8odGhpcyk7CgkJZWxzZQoJCQl0ZXh0LmFkZFRvKHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfQoKCWZ1bmN0aW9uIE5vblRlcm1pbmFsKHRleHQsIGhyZWYpIHsKCQlpZighKHRoaXMgaW5zdGFuY2VvZiBOb25UZXJtaW5hbCkpIHJldHVybiBuZXcgTm9uVGVybWluYWwodGV4dCwgaHJlZik7CgkJRmFrZVNWRy5jYWxsKHRoaXMsICdnJywgeydjbGFzcyc6ICdub24tdGVybWluYWwnfSk7CgkJdGhpcy50ZXh0ID0gdGV4dDsKCQl0aGlzLmhyZWYgPSBocmVmOwoJCXRoaXMud2lkdGggPSB0ZXh0Lmxlbmd0aCAqIDggKyAyMDsKCQl0aGlzLmhlaWdodCA9IDA7CgkJdGhpcy5vZmZzZXRYID0gMDsKCQl0aGlzLnVwID0gMTE7CgkJdGhpcy5kb3duID0gMTE7Cgl9CglzdWJjbGFzc09mKE5vblRlcm1pbmFsLCBGYWtlU1ZHKTsKCU5vblRlcm1pbmFsLnByb3RvdHlwZS5uZWVkc1NwYWNlID0gdHJ1ZTsKCU5vblRlcm1pbmFsLnByb3RvdHlwZS5mb3JtYXQgPSBmdW5jdGlvbih4LCB5LCB3aWR0aCkgewoJCS8vIEhvb2sgdXAgdGhlIHR3byBzaWRlcyBpZiB0aGlzIGlzIG5hcnJvd2VyIHRoYW4gaXRzIHN0YXRlZCB3aWR0aC4KCQl2YXIgZ2FwcyA9IGRldGVybWluZUdhcHMod2lkdGgsIHRoaXMud2lkdGgpOwoJCVBhdGgoeCx5KS5oKGdhcHNbMF0pLmFkZFRvKHRoaXMpOwoJCVBhdGgoeCtnYXBzWzBdK3RoaXMud2lkdGgseSkuaChnYXBzWzFdKS5hZGRUbyh0aGlzKTsKCQl4ICs9IGdhcHNbMF07CgoJCUZha2VTVkcoJ3JlY3QnLCB7eDp4LCB5OnktMTEsIHdpZHRoOnRoaXMud2lkdGgsIGhlaWdodDp0aGlzLnVwK3RoaXMuZG93bn0pLmFkZFRvKHRoaXMpOwoJCXZhciB0ZXh0ID0gRmFrZVNWRygndGV4dCcsIHt4OngrdGhpcy53aWR0aC8yLCB5OnkrNH0sIHRoaXMudGV4dCk7CgkJaWYodGhpcy5ocmVmKQoJCQlGYWtlU1ZHKCdhJywgeyd4bGluazpocmVmJzogdGhpcy5ocmVmfSwgW3RleHRdKS5hZGRUbyh0aGlzKTsKCQllbHNlCgkJCXRleHQuYWRkVG8odGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJZnVuY3Rpb24gQ29tbWVudCh0ZXh0KSB7CgkJaWYoISh0aGlzIGluc3RhbmNlb2YgQ29tbWVudCkpIHJldHVybiBuZXcgQ29tbWVudCh0ZXh0KTsKCQlGYWtlU1ZHLmNhbGwodGhpcywgJ2cnKTsKCQl0aGlzLnRleHQgPSB0ZXh0OwoJCXRoaXMud2lkdGggPSB0ZXh0Lmxlbmd0aCAqIDcgKyAxMDsKCQl0aGlzLmhlaWdodCA9IDA7CgkJdGhpcy5vZmZzZXRYID0gMDsKCQl0aGlzLnVwID0gMTE7CgkJdGhpcy5kb3duID0gMTE7Cgl9CglzdWJjbGFzc09mKENvbW1lbnQsIEZha2VTVkcpOwoJQ29tbWVudC5wcm90b3R5cGUubmVlZHNTcGFjZSA9IHRydWU7CglDb21tZW50LnByb3RvdHlwZS5mb3JtYXQgPSBmdW5jdGlvbih4LCB5LCB3aWR0aCkgewoJCS8vIEhvb2sgdXAgdGhlIHR3byBzaWRlcyBpZiB0aGlzIGlzIG5hcnJvd2VyIHRoYW4gaXRzIHN0YXRlZCB3aWR0aC4KCQl2YXIgZ2FwcyA9IGRldGVybWluZUdhcHMod2lkdGgsIHRoaXMud2lkdGgpOwoJCVBhdGgoeCx5KS5oKGdhcHNbMF0pLmFkZFRvKHRoaXMpOwoJCVBhdGgoeCtnYXBzWzBdK3RoaXMud2lkdGgseSt0aGlzLmhlaWdodCkuaChnYXBzWzFdKS5hZGRUbyh0aGlzKTsKCQl4ICs9IGdhcHNbMF07CgoJCUZha2VTVkcoJ3RleHQnLCB7eDp4K3RoaXMud2lkdGgvMiwgeTp5KzUsIGNsYXNzOidjb21tZW50J30sIHRoaXMudGV4dCkuYWRkVG8odGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJZnVuY3Rpb24gU2tpcCgpIHsKCQlpZighKHRoaXMgaW5zdGFuY2VvZiBTa2lwKSkgcmV0dXJuIG5ldyBTa2lwKCk7CgkJRmFrZVNWRy5jYWxsKHRoaXMsICdnJyk7CgkJdGhpcy53aWR0aCA9IDA7CgkJdGhpcy5oZWlnaHQgPSAwOwoJCXRoaXMub2Zmc2V0WCA9IDA7CgkJdGhpcy51cCA9IDA7CgkJdGhpcy5kb3duID0gMDsKCX0KCXN1YmNsYXNzT2YoU2tpcCwgRmFrZVNWRyk7CglTa2lwLnByb3RvdHlwZS5mb3JtYXQgPSBmdW5jdGlvbih4LCB5LCB3aWR0aCkgewoJCVBhdGgoeCx5KS5yaWdodCh3aWR0aCkuYWRkVG8odGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9CgkKCXZhciByb290OwoJaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewoJCS8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KCQlyb290ID0ge307CgkJZGVmaW5lKFtdLCBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHJvb3Q7CgkJfSk7Cgl9IGVsc2UgaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoJCS8vIENvbW1vbkpTIGZvciBub2RlCgkJcm9vdCA9IGV4cG9ydHM7Cgl9IGVsc2UgewoJCS8vIEJyb3dzZXIgZ2xvYmFscyAocm9vdCBpcyB3aW5kb3cpCgkJcm9vdCA9IHRoaXM7Cgl9CgoJdmFyIHRlbXAgPSBbRGlhZ3JhbSwgQ29tcGxleERpYWdyYW0sIFNlcXVlbmNlLCBTdGFjaywgQ2hvaWNlLCBPcHRpb25hbCwgT25lT3JNb3JlLCBaZXJvT3JNb3JlLCBUZXJtaW5hbCwgTm9uVGVybWluYWwsIENvbW1lbnQsIFNraXBdOwoJLyoKCVRoZXNlIGFyZSB0aGUgbmFtZXMgdGhhdCB0aGUgaW50ZXJuYWwgY2xhc3NlcyBhcmUgZXhwb3J0ZWQgYXMuCglJZiB5b3Ugd291bGQgbGlrZSBkaWZmZXJlbnQgbmFtZXMsIGFkanVzdCB0aGVtIGhlcmUuCgkqLwoJWydEaWFncmFtJywgJ0NvbXBsZXhEaWFncmFtJywgJ1NlcXVlbmNlJywgJ1N0YWNrJywgJ0Nob2ljZScsICdPcHRpb25hbCcsICdPbmVPck1vcmUnLCAnWmVyb09yTW9yZScsICdUZXJtaW5hbCcsICdOb25UZXJtaW5hbCcsICdDb21tZW50JywgJ1NraXAnXQoJCS5mb3JFYWNoKGZ1bmN0aW9uKGUsaSkgeyByb290W2VdID0gdGVtcFtpXTsgfSk7Cn0pLmNhbGwodGhpcywKCXsKCVZFUlRJQ0FMX1NFUEFSQVRJT046IDgsCglBUkNfUkFESVVTOiAxMCwKCURJQUdSQU1fQ0xBU1M6ICdyYWlscm9hZC1kaWFncmFtJywKCVNUUk9LRV9PRERfUElYRUxfTEVOR1RIOiB0cnVlLAoJSU5URVJOQUxfQUxJR05NRU5UOiAnY2VudGVyJywKCX0KKTsK"></script>
<script src="data:application/x-javascript;base64,SFRNTFdpZGdldHMud2lkZ2V0KHsKCiAgbmFtZTogJ3JhaWxyb2FkJywKCiAgdHlwZTogJ291dHB1dCcsCgogIGluaXRpYWxpemU6IGZ1bmN0aW9uKGVsLCB3aWR0aCwgaGVpZ2h0KSB7CgogICAgcmV0dXJuIHsgfQoKICB9LAoKICByZW5kZXJWYWx1ZTogZnVuY3Rpb24oZWwsIHgsIGluc3RhbmNlKSB7CiAgICAvLyBjbGVhbiBvdXQgZWwgZm9yIGR5bmFtaWMgLyBTaGlueSBzaXR1YXRpb25zCiAgICBlbC5pbm5lckhUTUwgPSAiIgogICAgCiAgICBEaWFncmFtLmFwcGx5KG51bGwseC5kaWFncmFtLm1hcChmdW5jdGlvbihkKXsKICAgICAgICB2YXIgZl87CiAgICAgICAgdHJ5IHsgCiAgICAgICAgICBmXyA9IGV2YWwoZCk7CiAgICAgICAgfSBjYXRjaChlKXsKICAgICAgICAgcmV0dXJuIGQ7IAogICAgICAgIH0KICAgICAgICByZXR1cm4gZl87CiAgICAgIH0pKS5hZGRUbyhlbCkKICB9LAoKICByZXNpemU6IGZ1bmN0aW9uKGVsLCB3aWR0aCwgaGVpZ2h0LCBpbnN0YW5jZSkgewoKICB9Cgp9KTsK"></script>
</head>
<body style="background-color:white;">
<div id="htmlwidget_container">
<div id="htmlwidget-7f4e524110367bd1ba6f" class="railroad html-widget" style="width:960px;height:500px;">

</div>
</div>
<script type="application/json" data-for="htmlwidget-7f4e524110367bd1ba6f">{"x":{"diagram":["Stack(Sequence(\"NationalITy\", Optional(\"PlaceofBirth \", \"skip\"), Choice(0, \"School_life\", OneOrMore(Sequence(NonTerminal(\"Academic\"), Optional(Sequence(\"Semester\", NonTerminal(\"Class\")))), \"Discussion\")), \"Activities\", OneOrMore(NonTerminal(\"raisedhands \"), \"Discussion\"), Optional(Sequence(\"VisITedResources\", NonTerminal(\"VisITedResources\")))), Sequence(Optional(Sequence(\"First_Sem\", NonTerminal(\"second_Sem\"))), Optional(Sequence(\"Scoring\", NonTerminal(\"A | B | C\"))), Optional(Sequence(Choice(0, \n    \"StageID\", \"GradeID\", \"SectionID\"), Optional(\"Gender\"), NonTerminal(\"Relation\")))), Sequence(Optional(Sequence(\"Education\", OneOrMore(Sequence(NonTerminal(\"Parents_involvement\"), Choice(0, Skip(), \"ParentAnsweringSurvey\", \"ParentschoolSatisfaction\")), \"Motivation\"))), Optional(Sequence(\"HighSchool\", Choice(0, NonTerminal(\"MiddleSchool\"), \"lowerlevel\"))), Optional(Sequence(\"Relation\", NonTerminal(\"Father\"), Optional(\"Mum\")))))"]},"evals":[],"jsHooks":[]}</script>
<script type="application/htmlwidget-sizing" data-for="htmlwidget-7f4e524110367bd1ba6f">{"viewer":{"width":450,"height":350,"padding":15,"fill":true},"browser":{"width":960,"height":500,"padding":40,"fill":false}}</script>
</body>
</html>
